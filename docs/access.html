<!doctype html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Access My Board · Taiko Quest NATC Phoenix 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./config.js"></script>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const { SUPABASE_URL, SUPABASE_KEY } = window.__ENV || {}
    if (!SUPABASE_URL || !SUPABASE_KEY) { alert('Missing Supabase config'); throw new Error('No config') }
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    const form = document.getElementById('form')
    const emailInput = document.getElementById('email')
    const sendBtn = document.getElementById('sendBtn')
    const msg = document.getElementById('msg')
    const state = document.getElementById('state')
    const consentWrap = document.getElementById('consentWrap')

    let sending = false, cooldownTimer = null
    const COOLDOWN_SEC = 60
    function redirectBase(){ return `${location.origin}${location.pathname}${location.search}` }
    function startCooldown(){
      let remain = COOLDOWN_SEC
      sendBtn.disabled = true
      sendBtn.classList.add('opacity-50','cursor-not-allowed')
      sendBtn.textContent = `Resend in ${remain}s`
      cooldownTimer = setInterval(()=>{
        remain -= 1
        if(remain<=0){
          clearInterval(cooldownTimer)
          sendBtn.disabled = false
          sendBtn.classList.remove('opacity-50','cursor-not-allowed')
          sendBtn.textContent = 'Email me a sign-in link'
        } else {
          sendBtn.textContent = `Resend in ${remain}s`
        }
      },1000)
    }

    async function signIn(e){
      e.preventDefault()

      // If already signed in, don’t send another email—continue the flow
      const { data:{ user: existing } } = await supabase.auth.getUser()
      if (existing) { afterLogin(); return }

      const email = emailInput.value.trim()
      if (!email) { msg.textContent = 'Email required.'; emailInput.focus(); return }
      if (sending) return
      sending = true
      msg.textContent = 'Sending magic link…'

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: redirectBase() }
      })
      sending = false
      if (error) { msg.textContent = 'Error: ' + error.message; return }
      msg.textContent = 'Check your email for the sign-in link.'
      startCooldown()
    }

    // Called when user returns via magic link or was already logged in
    async function afterLogin(){
      const { data:{ user } } = await supabase.auth.getUser()
      if(!user) return
      // Ensure profile exists
      await supabase.from('profiles').upsert(
        { id:user.id, email:user.email, display_name:user.user_metadata?.full_name||'' },
        { onConflict:'id' }
      )
      // Check consent + approval
      const { data: prof, error } = await supabase
        .from('profiles').select('consent,approved').eq('id', user.id).maybeSingle()
      if (error) { msg.textContent = 'Error: ' + error.message; return }
      if (!prof?.consent) { consentWrap.classList.remove('hidden'); return }

      // ✅ New: if profile is already approved, go straight to board
      if (prof?.approved) { location.href = './board.html'; return }

      // Otherwise, look up registration by email
      const { data: reg } = await supabase
        .from('registrations').select('status').eq('email', user.email).maybeSingle()

      if (reg?.status === 'approved') {
        await supabase.from('profiles').update({ approved:true }).eq('id', user.id)
        location.href = './board.html'
      } else {
        state.textContent='Pending approval. Please check back later.'
      }
    }

    async function agreeConsent(){
      const { data:{ user } } = await supabase.auth.getUser()
      await supabase.from('profiles').update({ consent:true }).eq('id', user.id)
      const { data: prof } = await supabase.from('profiles').select('consent,approved').eq('id', user.id).maybeSingle()
      // If approved already, go straight to board
      if (prof?.approved) { location.href = './board.html'; return }
      // Else run the gate (checks registrations)
      await afterLogin()
    }

    // Boot: proceed if session exists; also listen for auth state changes
    supabase.auth.getUser().then(({data:{user}})=>{ if(user) afterLogin() })
    supabase.auth.onAuthStateChange((event) => { if (event === 'SIGNED_IN') afterLogin() })

    // Wire up
    window.signIn = signIn
    window.agreeConsent = agreeConsent
  </script>
</head>
<body class="h-full">
  <main class="max-w-md mx-auto p-6">
    <h1 class="text-2xl font-semibold mb-4">Access My Board</h1>
    <form id="form" class="space-y-3" onsubmit="signIn(event)">
      <div>
        <label for="email" class="block text-sm">Email</label>
        <input id="email" name="email" type="email" autocomplete="email" inputmode="email"
               class="w-full rounded-xl border p-2.5" required />
      </div>
      <button id="sendBtn" class="w-full rounded-xl bg-gray-900 text-white py-2.5">
        Email me a sign-in link
      </button>
      <p class="text-xs text-gray-500 mt-1">No password needed. We’ll email you a one-time sign-in link.</p>
    </form>
    <p id="msg" class="text-sm text-gray-600 mt-3"></p>
    <p id="state" class="text-sm text-gray-800 mt-3"></p>

    <!-- Consent modal -->
    <div id="consentWrap" class="hidden fixed inset-0 bg-black/40 grid place-items-center p-4">
      <div class="bg-white rounded-2xl p-5 max-w-lg w-full">
        <h2 class="text-lg font-semibold mb-2">Media Consent</h2>
        <p class="text-sm text-gray-700">
          I agree that TCA may use photos/videos I submit for media purposes as described in the Terms.
        </p>
        <div class="mt-4 flex gap-2">
          <button onclick="agreeConsent()" class="px-4 py-2 rounded-xl bg-gray-900 text-white">I Agree</button>
          <a href="./TERMS.html" class="px-4 py-2 rounded-xl bg-gray-100">Read Terms</a>
          <a href="./PRIVACY.html" class="px-4 py-2 rounded-xl bg-gray-100">Privacy</a>
        </div>
      </div>
    </div>
  </main>
</body>
</html>
