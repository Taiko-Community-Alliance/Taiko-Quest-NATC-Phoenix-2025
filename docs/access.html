<!doctype html>
<html lang="en" class="h-full bg-gray-50 dark:bg-gray-900">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Access My Board · Taiko Quest NATC Phoenix 2025</title>
  <link rel="stylesheet" href="./assets/tailwind.css">
  <script src="./config.js"></script>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900">
  <div id="siteHeader"></div>

  <main class="max-w-md mx-auto p-4 sm:p-6 mt-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Access My Board</h2>
      <p class="text-gray-600 dark:text-gray-400 text-sm mb-6">Enter your email to get a 6-digit code.</p>

      <form id="form" class="space-y-4">
        <div id="nameFields">
          <label class="block text-sm font-bold mb-1">First name</label>
          <input name="first" class="w-full rounded-xl border p-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
          <label class="block text-sm font-bold mt-4 mb-1">Last name</label>
          <input name="last" class="w-full rounded-xl border p-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        </div>

        <label class="block text-sm font-bold mb-1">Email</label>
        <input name="email" id="email" type="email" required autocomplete="email"
              class="w-full rounded-xl border p-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />

        <div id="codeWrap" class="hidden">
          <label class="block text-sm font-bold mb-1">Verification code</label>
          <input name="code" id="code" inputmode="numeric" pattern="[0-9]*" maxlength="6"
                class="w-full rounded-xl border p-3 tracking-widest text-center dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
        </div>

        <button id="primaryBtn" type="submit"
                class="w-full rounded-xl bg-gray-900 dark:bg-gray-700 text-white py-3 font-bold">Send code</button>

        <button id="resendBtn" type="button"
                class="w-full rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-200 py-3 font-bold hidden">
          Resend code
        </button>
      </form>

      <div class="mt-4">
        <p id="msg" class="text-sm text-gray-600 dark:text-gray-400"></p>
        <p id="state" class="text-sm text-gray-800 dark:text-gray-200 mt-2"></p>
      </div>
    </div>
  </main>

  <script type="module">
    import { renderHeader, initHeader } from './js/header.js';
    import {
      supaFromConfig, ensureProfile, requestEmailCode, verifyEmailCode, redirectBaseNoHash
    } from './js/user-common.js';

    document.getElementById('siteHeader').outerHTML = renderHeader({
      admin:false, nav:[['Home','./index.html']], withAuth:false
    });
    initHeader();

    const supabase   = supaFromConfig();
    const form       = document.getElementById('form');
    const msg        = document.getElementById('msg');
    const state      = document.getElementById('state');
    const primaryBtn = document.getElementById('primaryBtn');
    const resendBtn  = document.getElementById('resendBtn');
    const codeWrap   = document.getElementById('codeWrap');
    const emailEl    = document.getElementById('email');
    const codeEl     = document.getElementById('code');
    const nameFields = document.getElementById('nameFields');

    let stage = 'send'; // 'send' | 'verify'
    let sending = false;
    const COOLDOWN_SEC = 60;
    let cooldownTimer = null;

    // Hide name fields if we’ve seen a name before
    (() => { const prev = localStorage.getItem('tq_name'); if (prev) nameFields.classList.add('hidden'); })();

    function setStage(next) {
      stage = next;
      if (stage === 'send') {
        codeWrap.classList.add('hidden');
        primaryBtn.textContent = 'Send code';
        resendBtn.classList.add('hidden');
      } else {
        codeWrap.classList.remove('hidden');
        primaryBtn.textContent = 'Verify code';
        resendBtn.classList.remove('hidden');
        codeEl?.focus();
      }
    }

    function startCooldown(){
      let remain = COOLDOWN_SEC;
      resendBtn.disabled = true;
      const baseTxt = 'Resend code';
      resendBtn.textContent = `${baseTxt} (${remain}s)`;
      cooldownTimer = setInterval(()=>{
        remain -= 1;
        if (remain <= 0) {
          clearInterval(cooldownTimer);
          resendBtn.disabled = false;
          resendBtn.textContent = baseTxt;
        } else {
          resendBtn.textContent = `${baseTxt} (${remain}s)`;
        }
      }, 1000);
    }

    // Send / Verify handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (sending) return;
      const email = emailEl.value.trim().toLowerCase();
      const first = e.target.first?.value?.trim() || '';
      const last  = e.target.last?.value?.trim() || '';
      if (!email) { msg.textContent = 'Email required.'; return; }

      // Save draft name (for registration later)
      if (first && last) {
        localStorage.setItem('tq_name', JSON.stringify({ first, last }));
        localStorage.setItem(`tq_reg:${email}`, JSON.stringify({ first, last }));
      }

      try {
        sending = true;
        msg.textContent = ''; state.textContent = '';

        if (stage === 'send') {
          const { ok, error } = await requestEmailCode(supabase, email);
          if (!ok) throw new Error(error || 'Unable to send code.');
          setStage('verify');
          startCooldown();
          msg.textContent = 'We sent you a 6-digit code. Check your email.';
        } else {
          const code = codeEl.value.trim();
          if (code.length < 6) { msg.textContent = 'Enter the 6-digit code.'; sending = false; return; }
          const { ok, error } = await verifyEmailCode(supabase, email, code);
          if (!ok) throw new Error(error || 'Invalid code.');
          // ensure profile then go to tracks
          await ensureProfile(supabase);
          window.location.replace('./tracks.html');
        }
      } catch (err) {
        msg.textContent = err?.message || 'Something went wrong.';
      } finally {
        sending = false;
      }
    });

    // Resend code with cooldown
    resendBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim().toLowerCase();
      if (!email || resendBtn.disabled) return;
      const { ok, error } = await requestEmailCode(supabase, email);
      if (!ok) { msg.textContent = 'Error: ' + error; return; }
      startCooldown();
      msg.textContent = 'Code resent.';
    });

    // If already signed in (e.g., returned visit), skip to tracks
    (async () => {
      const { data:{ session } } = await supabase.auth.getSession();
      if (session) {
        await ensureProfile(supabase);
        window.location.replace('./tracks.html');
      }
    })();
  </script>
</body>
</html>
