<!doctype html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin · People · Taiko Quest NATC Phoenix 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../config.js"></script>
  <script type="module" src="../js/admin-common.js"></script>
</head>
<body class="h-full">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <div>
        <div class="flex items-center justify-between">
          <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900">Admin · People</h1>
          <!-- Hamburger menu button (visible only on mobile) -->
          <button id="menuBtn" class="sm:hidden p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
        <p class="text-sm text-gray-600 break-all">Approve requests, promote/demote admins.</p>

        <!-- Mobile menu (hidden by default on mobile, always hidden on desktop) -->
        <div id="mobileMenu" class="sm:hidden hidden mt-3 p-3 bg-gray-50 rounded-lg shadow-sm">
          <div class="flex flex-col space-y-3">
            <div class="text-sm text-gray-600 break-all">
              Signed in as: <span id="whoami">Checking session…</span>
            </div>
            <div class="flex flex-col space-y-2">
              <a href="./questions.html" class="px-3 py-2 rounded-lg bg-gray-100 text-sm text-center">Questions</a>
              <a href="./verifications.html" class="px-3 py-2 rounded-lg bg-gray-100 text-sm text-center">Verifications</a>
              <button id="signin" class="px-3 py-2 rounded-lg bg-gray-900 text-white text-sm">Sign in</button>
              <button id="signout" class="px-3 py-2 rounded-lg bg-gray-200 text-gray-900 text-sm">Sign out</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Desktop view (hidden on mobile, visible on desktop) -->
      <div class="hidden sm:flex sm:items-center sm:gap-2">
        <span id="whoami-desktop" class="text-sm text-gray-600 break-all">Checking session…</span>
        <a href="./questions.html" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Questions</a>
        <a href="./verifications.html" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Verifications</a>
        <button id="signin-desktop" class="px-3 py-2 rounded-lg bg-gray-900 text-white text-sm">Sign in</button>
        <button id="signout-desktop" class="px-3 py-2 rounded-lg bg-gray-200 text-gray-900 text-sm">Sign out</button>
      </div>
    </header>

    <section id="content" class="hidden space-y-6">
      <!-- Pending registrations -->
      <div class="bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-4 sm:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-medium">Pending registrations</h2>
          <button id="refreshRegs" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Refresh</button>
        </div>
        <div id="regs" class="space-y-2 text-sm"></div>
      </div>

      <!-- Profiles & Admins -->
      <div class="bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-4 sm:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-medium">Profiles</h2>
          <div class="flex gap-2">
            <input id="searchEmail" placeholder="search email…" class="rounded-xl border p-2 text-sm" />
            <button id="refreshProfiles" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Refresh</button>
          </div>
        </div>
        <div id="profiles" class="space-y-2 text-sm"></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { supaFromConfig, requireAdmin, updateAuthUI, signInGoogle, signOut } from '../js/admin-common.js'
    const supabase = supaFromConfig()
    const ADMIN_DOMAIN = '@taikocommunityalliance.org'

    // Mobile elements
    const whoami = document.getElementById('whoami')
    const signin = document.getElementById('signin')
    const signout = document.getElementById('signout')

    // Desktop elements
    const whoamiDesktop = document.getElementById('whoami-desktop')
    const signinDesktop = document.getElementById('signin-desktop')
    const signoutDesktop = document.getElementById('signout-desktop')

    // Common elements
    const menuBtn = document.getElementById('menuBtn')
    const mobileMenu = document.getElementById('mobileMenu')
    const content = document.getElementById('content')
    const regsBox = document.getElementById('regs')
    const profilesBox = document.getElementById('profiles')
    const searchEmail = document.getElementById('searchEmail')
    const refreshRegsBtn = document.getElementById('refreshRegs')
    const refreshProfilesBtn = document.getElementById('refreshProfiles')

    // Toggle mobile menu
    menuBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden')
    })

    // Sign in/out functionality for both mobile and desktop buttons
    const handleSignIn = () => signInGoogle(supabase)
    const handleSignOut = () => signOut(supabase)

    signin.onclick = handleSignIn
    signout.onclick = handleSignOut
    signinDesktop.onclick = handleSignIn
    signoutDesktop.onclick = handleSignOut

    async function boot() {
      // For mobile view
      const guard = await requireAdmin(supabase, ADMIN_DOMAIN, { signinBtn: signin, signoutBtn: signout, whoami })

      // For desktop view - manually update the UI elements
      if (guard.user) {
        whoamiDesktop.textContent = guard.user.email
        signinDesktop.classList.add('hidden')
        signoutDesktop.classList.remove('hidden')
      } else {
        whoamiDesktop.textContent = 'Not signed in'
        signinDesktop.classList.remove('hidden')
        signoutDesktop.classList.add('hidden')
      }

      if (!guard.admin) return
      content.classList.remove('hidden')
      await Promise.all([loadRegs(), loadProfiles()])
    }

    async function loadRegs() {
      regsBox.innerHTML = '<div class="text-gray-500">Loading…</div>'
      const { data, error } = await supabase.from('registrations')
        .select('id,email,first_name,last_name,created_at,status')
        .eq('status','pending').order('created_at', { ascending: true })
      if (error) { regsBox.innerHTML = `<div class="text-red-700">Error: ${error.message}</div>`; return }
      if (!data?.length) { regsBox.innerHTML = '<div class="text-gray-600">No pending registrations.</div>'; return }
      regsBox.innerHTML = ''
      for (const r of data) {
        const row = document.createElement('div')
        row.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 p-2 rounded-lg ring-1 ring-gray-200'
        row.innerHTML = `
          <div>
            <div class="font-medium">${r.first_name} ${r.last_name}</div>
            <div class="text-gray-600 break-all">${r.email}</div>
            <div class="text-gray-500 text-xs">requested ${new Date(r.created_at).toLocaleString()}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn-approve px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm" data-id="${r.id}" data-email="${r.email}">Approve</button>
            <button class="btn-reject px-3 py-1.5 rounded-lg bg-red-600 text-white text-sm" data-id="${r.id}">Reject</button>
          </div>
        `
        regsBox.appendChild(row)
      }
      regsBox.querySelectorAll('.btn-approve').forEach(b => b.onclick = approveReg)
      regsBox.querySelectorAll('.btn-reject').forEach(b => b.onclick = rejectReg)
      refreshProfilesBtn.click() // show fresh list after actions
    }

    async function approveReg(e) {
      const id = e.currentTarget.dataset.id
      const email = e.currentTarget.dataset.email
      // 1) mark registration approved
      await supabase.from('registrations').update({ status:'approved', approved_at: new Date().toISOString() }).eq('id', id)
      // 2) set matching profile.approved=true if profile exists
      await supabase.from('profiles').update({ approved: true }).eq('email', email)
      await loadRegs()
    }
    async function rejectReg(e) {
      const id = e.currentTarget.dataset.id
      await supabase.from('registrations').update({ status:'rejected' }).eq('id', id)
      await loadRegs()
    }

    async function loadProfiles() {
      profilesBox.innerHTML = '<div class="text-gray-500">Loading…</div>'
      let q = supabase.from('profiles').select('id,email,display_name,approved,role,created_at').order('created_at',{ascending:false}).limit(50)
      const term = (searchEmail.value||'').trim()
      if (term) q = q.ilike('email', `%${term}%`)
      const { data, error } = await q
      if (error) { profilesBox.innerHTML = `<div class="text-red-700">Error: ${error.message}</div>`; return }
      profilesBox.innerHTML = ''
      for (const p of data||[]) {
        const row = document.createElement('div')
        row.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 p-2 rounded-lg ring-1 ring-gray-200'
        row.innerHTML = `
          <div>
            <div class="font-medium break-all">${p.email}</div>
            <div class="text-gray-600 text-sm">${p.display_name||'—'}</div>
            <div class="text-gray-500 text-xs">${new Date(p.created_at).toLocaleString()}</div>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs px-2 py-1 rounded-full ${p.approved?'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200':'bg-gray-100 text-gray-700 ring-1 ring-gray-200'}">
              ${p.approved?'approved':'pending'}
            </span>
            <span class="text-xs px-2 py-1 rounded-full ${p.role==='admin'?'bg-indigo-50 text-indigo-700 ring-1 ring-indigo-200':'bg-gray-100 text-gray-700 ring-1 ring-gray-200'}">
              ${p.role}
            </span>
            <button class="btn-toggle-approve px-3 py-1.5 rounded-lg bg-gray-100 text-sm" data-id="${p.id}" data-now="${p.approved}">
              ${p.approved?'Revoke':'Approve'}
            </button>
            <button class="btn-toggle-role px-3 py-1.5 rounded-lg bg-gray-900 text-white text-sm" data-id="${p.id}" data-role="${p.role}">
              ${p.role==='admin'?'Demote to attendee':'Promote to admin'}
            </button>
          </div>
        `
        profilesBox.appendChild(row)
      }
      profilesBox.querySelectorAll('.btn-toggle-approve').forEach(b=>b.onclick = async (e)=>{
        const id = e.currentTarget.dataset.id; const now = e.currentTarget.dataset.now === 'true'
        await supabase.from('profiles').update({ approved: !now }).eq('id', id); loadProfiles()
      })
      profilesBox.querySelectorAll('.btn-toggle-role').forEach(b=>b.onclick = async (e)=>{
        const id = e.currentTarget.dataset.id; const role = e.currentTarget.dataset.role
        const to = role==='admin' ? 'attendee' : 'admin'
        await supabase.from('profiles').update({ role: to }).eq('id', id); loadProfiles()
      })
    }

    refreshRegsBtn.onclick = loadRegs
    refreshProfilesBtn.onclick = loadProfiles
    searchEmail.oninput = () => { loadProfiles() }

    boot()
  </script>
</body>
</html>
