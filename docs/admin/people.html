<!doctype html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin · People · Taiko Quest NATC Phoenix 2025</title>
  <link rel="stylesheet" href="../assets/tailwind.css">
  <script src="../config.js"></script>
</head>
<body class="h-full">
  <div class="max-w-7xl mx-auto p-4 sm:p-6">
    <div id="siteHeader"></div>

    <section id="content" class="hidden space-y-6 mt-4">
      <!-- Pending registrations -->
      <div class="bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-4 sm:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Pending registrations</h2>
          <button id="refreshRegs" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Refresh</button>
        </div>
        <div id="regs" class="space-y-2 text-sm"></div>
      </div>

      <!-- Profiles + Admin control -->
      <div class="bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-4 sm:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Profiles</h2>
          <div class="flex gap-2">
            <input id="searchEmail" placeholder="search email…" class="rounded-xl border p-2 text-sm" />
            <button id="refreshProfiles" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Refresh</button>
          </div>
        </div>
        <div id="profiles" class="space-y-2 text-sm"></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { renderHeader, initHeader, bindAuthButtons } from '../js/header.js'
    import { supaFromConfig, requireAdmin, signInGoogle, signOut } from '../js/admin-common.js'

    document.getElementById('siteHeader').outerHTML = renderHeader({
      admin: true,
      nav: [
        ['Admin','./index.html'],
        ['People','./people.html'],
        ['Questions','./questions.html'],
        ['Verifications','./verifications.html'],
      ],
      withAuth: true
    })
    initHeader()

    const supabase = supaFromConfig()
    bindAuthButtons({
      onSignIn: () => signInGoogle(supabase),
      onSignOut: () => signOut(supabase)
    })

    const whoami  = document.getElementById('whoami')
    const signin  = document.getElementById('signin')
    const signout = document.getElementById('signout')

    const content = document.getElementById('content')
    const regsBox = document.getElementById('regs')
    const profilesBox = document.getElementById('profiles')
    const searchEmail = document.getElementById('searchEmail')
    const refreshRegsBtn = document.getElementById('refreshRegs')
    const refreshProfilesBtn = document.getElementById('refreshProfiles')

    const guard = await requireAdmin(supabase, null, { signinBtn: signin, signoutBtn: signout, whoami })
    if (!guard.admin) { window.location.replace('../request.html'); }

    content.classList.remove('hidden')
    await Promise.all([loadRegs(), loadProfiles()])

    refreshRegsBtn.onclick = loadRegs
    refreshProfilesBtn.onclick = loadProfiles
    searchEmail.oninput = () => { loadProfiles() }

    async function loadRegs() {
      regsBox.innerHTML = '<div class="text-gray-500">Loading…</div>'
      const { data, error } = await supabase.from('registrations')
        .select('id,email,first_name,last_name,created_at,status')
        .eq('status','pending')
        .order('created_at',{ ascending:true })
      if (error) { regsBox.innerHTML = `<div class="text-red-700">Error: ${error.message}</div>`; return }
      if (!data?.length) { regsBox.innerHTML = '<div class="text-gray-600">No pending registrations.</div>'; return }
      regsBox.innerHTML = ''
      for (const r of data) {
        const row = document.createElement('div')
        row.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 p-2 rounded-lg ring-1 ring-gray-200'
        row.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(r.first_name)} ${escapeHtml(r.last_name)}</div>
            <div class="text-gray-600">${escapeHtml(r.email)}</div>
            <div class="text-gray-500 text-xs">requested ${new Date(r.created_at).toLocaleString()}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn-approve px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm" data-id="${r.id}" data-email="${r.email}">Approve</button>
            <button class="btn-reject px-3 py-1.5 rounded-lg bg-red-600 text-white text-sm" data-id="${r.id}">Reject</button>
          </div>
        `
        regsBox.appendChild(row)
      }
      regsBox.querySelectorAll('.btn-approve').forEach(b => b.onclick = approveReg)
      regsBox.querySelectorAll('.btn-reject').forEach(b => b.onclick = rejectReg)
    }

    async function approveReg(e) {
      const id = e.currentTarget.dataset.id
      const email = e.currentTarget.dataset.email
      // 1) mark registration approved
      await supabase.from('registrations')
        .update({ status:'approved', approved_at: new Date().toISOString() })
        .eq('id', id)
      // 2) if profile already exists (user has logged once), approve it
      await supabase.from('profiles').update({ approved: true }).eq('email', email)
      await Promise.all([loadRegs(), loadProfiles()])
    }

    async function rejectReg(e) {
      const id = e.currentTarget.dataset.id
      await supabase.from('registrations').update({ status:'rejected' }).eq('id', id)
      await loadRegs()
    }

    async function loadProfiles() {
      profilesBox.innerHTML = '<div class="text-gray-500">Loading…</div>'

      // Try the convenience view first (v_profiles_adminflag). If missing, fall back.
      let rows = null, err = null
      let usedView = true
      try {
        const q1 = supabase.from('v_profiles_adminflag')
          .select('id,email,display_name,approved,is_admin,created_at')
        const term = (searchEmail.value||'').trim()
        const q2 = term ? q1.ilike('email', `%${term}%`) : q1
        const { data, error } = await q2.order('created_at',{ascending:false}).limit(100)
        if (error) throw error
        rows = data
      } catch (e) {
        usedView = false
        err = e
      }

      if (!rows) {
        // Fallback: fetch profiles + admins and merge on client
        const term = (searchEmail.value||'').trim()
        const { data: profs, error: e1 } = await (
          term
            ? supabase.from('profiles').select('id,email,display_name,approved,created_at').ilike('email', `%${term}%`)
            : supabase.from('profiles').select('id,email,display_name,approved,created_at')
        ).order('created_at',{ascending:false}).limit(100)
        if (e1) { profilesBox.innerHTML = `<div class="text-red-700">Error: ${e1.message}</div>`; return }
        const { data: admins, error: e2 } = await supabase.from('admins').select('user_id')
        if (e2) { profilesBox.innerHTML = `<div class="text-red-700">Error: ${e2.message}</div>`; return }
        const adminSet = new Set((admins||[]).map(a=>a.user_id))
        rows = (profs||[]).map(p => ({ ...p, is_admin: adminSet.has(p.id) }))
      }

      if (!rows.length) { profilesBox.innerHTML = '<div class="text-gray-600">No profiles found.</div>'; return }

      profilesBox.innerHTML = ''
      for (const p of rows) {
        const row = document.createElement('div')
        row.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 p-2 rounded-lg ring-1 ring-gray-200'
        row.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(p.email)}</div>
            <div class="text-gray-600 text-sm">${escapeHtml(p.display_name || '—')}</div>
            <div class="text-gray-500 text-xs">${new Date(p.created_at).toLocaleString()}</div>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs px-2 py-1 rounded-full ${p.approved?'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200':'bg-gray-100 text-gray-700 ring-1 ring-gray-200'}">
              ${p.approved?'approved':'pending'}
            </span>
            <span class="text-xs px-2 py-1 rounded-full ${p.is_admin?'bg-indigo-50 text-indigo-700 ring-1 ring-indigo-200':'bg-gray-100 text-gray-700 ring-1 ring-gray-200'}">
              ${p.is_admin ? 'admin' : 'attendee'}
            </span>
            <button class="btn-toggle-approve px-3 py-1.5 rounded-lg bg-gray-100 text-sm" data-id="${p.id}" data-now="${p.approved}">
              ${p.approved?'Revoke':'Approve'}
            </button>
            <button class="btn-toggle-admin px-3 py-1.5 rounded-lg ${p.is_admin?'bg-white text-gray-900 ring-1 ring-gray-300':'bg-gray-900 text-white'} text-sm" data-id="${p.id}" data-admin="${p.is_admin}">
              ${p.is_admin ? 'Demote from admin' : 'Promote to admin'}
            </button>
          </div>
        `
        profilesBox.appendChild(row)
      }

      profilesBox.querySelectorAll('.btn-toggle-approve').forEach(b=>b.onclick = async (e)=>{
        const id = e.currentTarget.dataset.id; const now = e.currentTarget.dataset.now === 'true'
        const { error } = await supabase.from('profiles').update({ approved: !now }).eq('id', id)
        if (error) alert(error.message); else loadProfiles()
      })
      profilesBox.querySelectorAll('.btn-toggle-admin').forEach(b=>b.onclick = async (e)=>{
        const id = e.currentTarget.dataset.id; const isAdmin = e.currentTarget.dataset.admin === 'true'
        let error = null
        if (isAdmin) {
          ({ error } = await supabase.from('admins').delete().eq('user_id', id))
        } else {
          ({ error } = await supabase.from('admins').insert({ user_id: id }))
        }
        if (error) alert(error.message); else loadProfiles()
      })
    }

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])) }
  </script>
</body>
</html>