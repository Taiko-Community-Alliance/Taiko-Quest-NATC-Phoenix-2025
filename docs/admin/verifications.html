<!doctype html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin · Verifications · Taiko Quest NATC Phoenix 2025</title>
  <link rel="stylesheet" href="../assets/tailwind.css">
  <!-- runtime config (generated by Actions/Codespaces; do NOT commit) -->
  <script src="../config.js"></script>
</head>
<body class="h-full">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <div id="siteHeader"></div>

    <section id="content" class="hidden">
      <div class="bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
          <h2 class="text-lg font-medium">Unverified submissions</h2>
          <div class="flex gap-2">
            <input id="filterEmail" class="rounded-xl border p-2 text-sm" placeholder="filter by email…" />
            <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Refresh</button>
          </div>
        </div>

        <div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>

        <div class="flex items-center justify-between mt-4">
          <button id="prevBtn" class="px-3 py-2 rounded-xl bg-gray-100 text-sm disabled:opacity-50" disabled>Prev</button>
          <span id="pageInfo" class="text-sm text-gray-600">Page 1</span>
          <button id="nextBtn" class="px-3 py-2 rounded-xl bg-gray-100 text-sm disabled:opacity-50" disabled>Next</button>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { renderHeader, initHeader } from '../js/header.js'
    import {
      supaFromConfig,
      requireAdmin,
      signInGoogle,
      signOut
    } from '../js/admin-common.js'

    document.getElementById('siteHeader').outerHTML = renderHeader({
        admin: true,
        nav: [
            ['Admin', './index.html'],
            ['People', './people.html'],
            ['Questions', './questions.html'],
            // ['Reports', './reports.html'], --- IGNORE ---
        ],
        withAuth: true,
    })
    initHeader()

    const supabase = supaFromConfig()
    const ADMIN_DOMAIN = '@taikocommunityalliance.org'

    // Mobile elements
    const whoami = document.getElementById('whoami')
    const signin = document.getElementById('signin')
    const signout = document.getElementById('signout')

    // Common elements
    const menuBtn = document.getElementById('menuBtn')
    const mobileMenu = document.getElementById('mobileMenu')
    const content = document.getElementById('content')
    const list    = document.getElementById('list')
    const refreshBtn = document.getElementById('refreshBtn')
    const filterEmail = document.getElementById('filterEmail')
    const prevBtn = document.getElementById('prevBtn')
    const nextBtn = document.getElementById('nextBtn')
    const pageInfo = document.getElementById('pageInfo')

    // Toggle mobile menu
    menuBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden')
    })

    const handleSignIn = () => signInGoogle(supabase)
    const handleSignOut = () => signOut(supabase)

    signin.onclick = handleSignIn
    signout.onclick = handleSignOut

    let page = 1, PAGE_SIZE = 12, lastCount = 0

    async function boot() {
      // For mobile view
      const guard = await requireAdmin(supabase, ADMIN_DOMAIN, { signinBtn: signin, signoutBtn: signout, whoami })

      if (!guard.admin) return
      content.classList.remove('hidden')
      await load()
    }

    async function load() {
      list.innerHTML = '<div class="text-gray-500">Loading…</div>'

      // Query the reporting view (created earlier)
      // Expected columns: id, proof_url, verified, question_text, owner_email
      let q = supabase
        .from('v_unverified_items')
        .select('id, proof_url, question_text, owner_email', { count: 'exact' })
        .order('id', { ascending: false })

      const term = (filterEmail.value || '').trim()
      if (term) q = q.ilike('owner_email', `%${term}%`)

      const from = (page - 1) * PAGE_SIZE
      const to   = from + PAGE_SIZE - 1

      const { data, count, error } = await q.range(from, to)
      if (error) { list.innerHTML = `<div class="text-red-700">Error: ${error.message}</div>`; return }

      lastCount = count ?? 0
      pageInfo.textContent = `Page ${page} · ${lastCount} total`
      prevBtn.disabled = page <= 1
      nextBtn.disabled = (page * PAGE_SIZE) >= lastCount

      if (!data?.length) { list.innerHTML = '<div class="text-gray-600">No unverified submissions.</div>'; return }

      list.innerHTML = ''
      for (const it of data) {
        const isVideo = it.proof_url?.match(/\.(mp4|mov|webm|m4v)(\?|$)/i)
        const media = isVideo
          ? `<video src="${it.proof_url}" class="w-full h-40 object-cover rounded-lg" controls></video>`
          : `<img src="${it.proof_url}" class="w-full h-40 object-cover rounded-lg" alt="proof">`
        const card = document.createElement('div')
        card.className = 'bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-4 flex flex-col gap-2'
        card.innerHTML = `
          <div class="text-xs text-gray-600 break-all">${it.owner_email}</div>
          <div class="text-sm font-medium">${it.question_text || '—'}</div>
          <div>${media}</div>
          <div class="flex gap-2">
            <button class="btn-verify px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm" data-id="${it.id}">Verify ✓</button>
            <a class="px-3 py-1.5 rounded-lg bg-gray-100 text-sm" href="${it.proof_url}" target="_blank">Open</a>
          </div>
        `
        list.appendChild(card)
      }

      list.querySelectorAll('.btn-verify').forEach(b => b.onclick = verifyItem)
    }

    async function verifyItem(e) {
      const id = e.currentTarget.dataset.id
      // Update the base table; view is read-only
      const { error } = await supabase.from('board_items').update({ verified: true }).eq('id', id)
      if (error) { alert('Verify failed: ' + error.message); return }
      await load()
    }

    prevBtn.onclick = () => { if (page > 1) { page--; load() } }
    nextBtn.onclick = () => { if ((page * PAGE_SIZE) < lastCount) { page++; load() } }
    refreshBtn.onclick = () => { page = 1; load() }
    filterEmail.oninput = () => { page = 1; load() }

    boot()
  </script>
</body>
</html>
