<!doctype html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin · Questions · Taiko Quest NATC Phoenix 2025</title>
  <link rel="stylesheet" href="../assets/tailwind.css">
  <!-- Runtime config (generated by Actions/Codespaces; do NOT commit) -->
  <script src="../config.js"></script>
</head>
<body class="h-full">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <div id="siteHeader"></div>

    <!-- Create question -->
    <section id="createBox" class="hidden bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-4 sm:p-6 mb-6">
      <h2 class="text-lg font-medium text-gray-900 mb-3">Create question</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
        <div class="sm:col-span-2 lg:col-span-3">
          <label for="qtext" class="block text-sm font-medium text-gray-700 mb-1">Question text</label>
          <textarea id="qtext" class="w-full rounded-xl border-gray-300 focus:border-gray-900 focus:ring-gray-900 p-3"
            rows="3" placeholder="e.g., Take a photo with a first-time attendee"></textarea>
        </div>
        <div>
          <!-- CHANGED to select with fixed tracks -->
          <label for="qcat" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select id="qcat" class="w-full rounded-xl border-gray-300 focus:border-gray-900 focus:ring-gray-900 p-2.5">
            <option value="shimedaiko">Shimedaiko</option>
            <option value="odaiko">Odaiko</option>
            <option value="chudaiko">Chūdaiko</option>
            <option value="okedo">Okedō</option>
          </select>
        </div>
        <div>
          <!-- LEVEL now 1–4 numerics -->
          <label for="qlevel" class="block text-sm font-medium text-gray-700 mb-1">Level</label>
          <select id="qlevel" class="w-full rounded-xl border-gray-300 focus:border-gray-900 focus:ring-gray-900 p-2.5">
            <option value="1">1 (Easy)</option>
            <option value="2">2 (Medium)</option>
            <option value="3">3 (Hard)</option>
            <option value="4">4 (Expert)</option>
          </select>
        </div>
        <div>
          <label for="qactive" class="block text-sm font-medium text-gray-700 mb-1">Active?</label>
          <select id="qactive" class="w-full rounded-xl border-gray-300 focus:border-gray-900 focus:ring-gray-900 p-2.5">
            <option value="true" selected>Yes</option>
            <option value="false">No</option>
          </select>
        </div>
        <div class="sm:self-end">
          <button id="createBtn" class="w-full sm:w-auto px-4 py-2.5 rounded-xl bg-gray-900 text-white text-sm font-medium hover:bg-black">
            Add question
          </button>
        </div>
      </div>
      <p id="createMsg" class="text-sm text-gray-600 mt-2"></p>
      <!-- NEW: Copy hint -->
      <p id="copyHint" class="text-xs text-gray-500 mt-1 hidden">Prefilled from #<span id="copyId"></span></p>
    </section>

    <!-- Filters -->
    <section id="controls" class="hidden bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-4 sm:p-6 mb-4">
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-3">
        <div>
          <label for="filterActive" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select id="filterActive" class="w-full rounded-xl border-gray-300 focus:border-gray-900 focus:ring-gray-900 p-2.5">
            <option value="all">All</option>
            <option value="active" selected>Active only</option>
            <option value="inactive">Inactive only</option>
          </select>
        </div>
        <div>
          <!-- CHANGED: numeric levels -->
          <label for="filterLevel" class="block text-sm font-medium text-gray-700 mb-1">Level</label>
          <select id="filterLevel" class="w-full rounded-xl border-gray-300 focus:border-gray-900 focus:ring-gray-900 p-2.5">
            <option value="all" selected>All</option>
            <option value="1">1 (Easy)</option>
            <option value="2">2 (Medium)</option>
            <option value="3">3 (Hard)</option>
            <option value="4">4 (Expert)</option>
          </select>
        </div>
        <div>
          <!-- NEW: category filter -->
          <label for="filterCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select id="filterCategory" class="w-full rounded-xl border-gray-300 focus:border-gray-900 focus:ring-gray-900 p-2.5">
            <option value="all" selected>All</option>
            <option value="shimedaiko">Shimedaiko</option>
            <option value="odaiko">Odaiko</option>
            <option value="chudaiko">Chūdaiko</option>
            <option value="okedo">Okedō</option>
          </select>
        </div>
        <div class="sm:col-span-2">
          <label for="searchText" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
          <input id="searchText" type="text" class="w-full rounded-xl border-gray-300 focus:border-gray-900 focus:ring-gray-900 p-2.5"
                 placeholder="contains text…" />
        </div>
      </div>
      <div class="mt-3">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Refresh</button>
      </div>
    </section>

    <!-- Questions list -->
    <section id="listBox" class="hidden">
      <div id="qlist" class="grid grid-cols-1 gap-3"></div>
      <div class="flex items-center justify-between mt-4">
        <button id="prevBtn" class="px-3 py-2 rounded-xl bg-gray-100 text-sm disabled:opacity-50" disabled>Prev</button>
        <span id="pageInfo" class="text-sm text-gray-600">Page 1</span>
        <button id="nextBtn" class="px-3 py-2 rounded-xl bg-gray-100 text-sm disabled:opacity-50" disabled>Next</button>
      </div>
    </section>
  </div>

  <!-- App -->
  <script type="module">
    import { renderHeader, initHeader } from '../js/header.js'
    import {
      supaFromConfig,
      requireAdmin,
      signInGoogle,
      signOut
    } from '../js/admin-common.js'

    document.getElementById('siteHeader').outerHTML = renderHeader({
        admin: true,
        nav: [
            ['Admin', './index.html'],
            ['People', './people.html'],
            ['Verifications', './verifications.html'],
        ],
        withAuth: true,
    })
    initHeader()
    const supabase = supaFromConfig()
    const ADMIN_DOMAIN = '@taikocommunityalliance.org' // optional UI gate; RLS still enforces

    // Mobile elements
    const whoami = document.getElementById('whoami')
    const signin = document.getElementById('signin')
    const signout = document.getElementById('signout')

    // Common elements
    const menuBtn = document.getElementById('menuBtn')
    const mobileMenu = document.getElementById('mobileMenu')
    const createBox = document.getElementById('createBox')
    const controls = document.getElementById('controls')
    const listBox = document.getElementById('listBox')
    const qlist = document.getElementById('qlist')

    const qtext = document.getElementById('qtext')
    const qcat = document.getElementById('qcat')
    const qlevel = document.getElementById('qlevel')
    const qactive = document.getElementById('qactive')
    const createBtn = document.getElementById('createBtn')
    const createMsg = document.getElementById('createMsg')
    const copyHint = document.getElementById('copyHint') // NEW
    const copyIdSpan = document.getElementById('copyId') // NEW

    const filterActive = document.getElementById('filterActive')
    const filterLevel = document.getElementById('filterLevel')
    const filterCategory = document.getElementById('filterCategory') // NEW
    const searchText = document.getElementById('searchText')
    const refreshBtn = document.getElementById('refreshBtn')
    const prevBtn = document.getElementById('prevBtn')
    const nextBtn = document.getElementById('nextBtn')
    const pageInfo = document.getElementById('pageInfo')

    // Toggle mobile menu
    if (menuBtn && mobileMenu) {
      menuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden')
      })
    }

    const handleSignIn = () => signInGoogle(supabase)
    const handleSignOut = () => signOut(supabase)

    signin.onclick = handleSignIn
    signout.onclick = handleSignOut

    let page = 1
    const PAGE_SIZE = 20
    let lastCount = 0

    async function boot() {
      const guard = await requireAdmin(supabase, ADMIN_DOMAIN, { signinBtn: signin, signoutBtn: signout, whoami })
      if (!guard.admin) return
      createBox.classList.remove('hidden')
      controls.classList.remove('hidden')
      listBox.classList.remove('hidden')
      await loadQuestions()
    }

    // Create a question
    createBtn.addEventListener('click', async () => {
      const text = qtext.value.trim()
      if (!text) { createMsg.textContent = 'Please enter question text.'; return }
      createBtn.disabled = true; createMsg.textContent = 'Saving…'
      const { error } = await supabase.from('questions').insert({
        text,
        category: qcat.value || null,
        level: parseInt(qlevel.value, 10),
        active: qactive.value === 'true'
      })
      createBtn.disabled = false
      if (error) { createMsg.textContent = 'Error: ' + error.message; return }
      createMsg.textContent = 'Saved!'
      qtext.value = ''; qcat.value = 'shimedaiko'; qlevel.value = '1'; qactive.value = 'true' // CHANGED defaults
      copyHint.classList.add('hidden') // NEW
      await loadQuestions()
      setTimeout(() => (createMsg.textContent = ''), 1500)
    })

    // Filters + pagination
    refreshBtn.onclick = () => { page = 1; loadQuestions() }
    filterActive.onchange = () => { page = 1; loadQuestions() }
    filterLevel.onchange  = () => { page = 1; loadQuestions() }
    filterCategory.onchange = () => { page = 1; loadQuestions() } // NEW
    searchText.oninput    = () => { page = 1; loadQuestions() }
    prevBtn.onclick = () => { if (page > 1) { page--; loadQuestions() } }
    nextBtn.onclick = () => { if ((page * PAGE_SIZE) < lastCount) { page++; loadQuestions() } }

    async function loadQuestions() {
      qlist.innerHTML = skeleton()
      let q = supabase.from('questions').select('*', { count: 'exact' })
        .order('active', { ascending: false })
        .order('text', { ascending: true })

      if (filterActive.value === 'active')   q = q.eq('active', true)
      if (filterActive.value === 'inactive') q = q.eq('active', false)

      if (filterLevel.value !== 'all') {
        const lvl = parseInt(filterLevel.value, 10)
        q = q.eq('level', lvl)
      }

      // NEW: Category filter
      if (filterCategory.value !== 'all') {
        q = q.eq('category', filterCategory.value)
      }

      if (searchText.value.trim()) q = q.ilike('text', `%${searchText.value.trim()}%`)

      const from = (page - 1) * PAGE_SIZE
      const to   = from + PAGE_SIZE - 1
      const { data, count, error } = await q.range(from, to)
      if (error) { qlist.innerHTML = errorCard(error.message); return }

      lastCount = count ?? 0
      pageInfo.textContent = `Page ${page} · ${lastCount} total`
      prevBtn.disabled = page <= 1
      nextBtn.disabled = (page * PAGE_SIZE) >= lastCount

      if (!data?.length) { qlist.innerHTML = emptyCard(); return }
      qlist.innerHTML = ''
      for (const row of data) qlist.appendChild(renderQuestionCard(row))
    }

    function skeleton() {
      return `<div class="bg-white rounded-2xl ring-1 ring-black/5 p-4 animate-pulse text-sm text-gray-500">Loading…</div>`
    }
    function emptyCard() {
      return `<div class="bg-white rounded-2xl ring-1 ring-black/5 p-6 text-gray-600">No questions found.</div>`
    }
    function errorCard(msg) {
      return `<div class="bg-white rounded-2xl ring-1 ring-red-300 p-6 text-red-700">Error: ${msg}</div>`
    }

    const TRACK_LABEL = { shimedaiko:'Shimedaiko', odaiko:'Odaiko', chudaiko:'Chūdaiko', okedo:'Okedō' }
    const LEVEL_LABEL = { 1:'1 (Easy)', 2:'2 (Medium)', 3:'3 (Hard)', 4:'4 (Expert)' }

    function renderQuestionCard(q) {
      const wrap = document.createElement('div')
      wrap.className = 'bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-4 sm:p-5'
      wrap.innerHTML = `
        <div class="flex items-center justify-between gap-3">
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${q.active ? 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200' : 'bg-gray-100 text-gray-700 ring-1 ring-gray-200'}">
            ${q.active ? 'active' : 'inactive'}
          </span>
          <div class="text-xs text-gray-500 space-x-3">
            <span>category: ${TRACK_LABEL[q.category] || q.category || '—'}</span>
            <span>level: ${LEVEL_LABEL[q.level] || q.level || '—'}</span>
          </div>
        </div>

        <div class="mt-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Text</label>
          <textarea data-id="${q.id}" class="w-full rounded-xl border-gray-300 focus:border-gray-900 focus:ring-gray-900 p-3" rows="3">${q.text}</textarea>
        </div>

        <!-- NEW: Inline controls row -->
        <div class="mt-3 flex flex-wrap items-center gap-2">
          <label class="text-xs flex items-center gap-1">
            Level:
            <select class="levelSel rounded border p-1 text-xs" data-id="${q.id}">
              ${[1,2,3,4].map(n=>`<option value="${n}" ${q.level===n?'selected':''}>${n}</option>`).join('')}
            </select>
          </label>

          <label class="text-xs inline-flex items-center gap-2 ml-3">
            <input type="checkbox" class="activeChk" data-id="${q.id}" ${q.active ? 'checked' : ''} />
            Active
          </label>

          <button class="btn-copy px-3 py-1.5 rounded-lg bg-gray-100 text-sm ml-auto" data-id="${q.id}">Copy to form</button>
        </div>

        <div class="mt-3 flex flex-wrap gap-2">
          <button class="btn-save px-3 py-2 rounded-xl bg-gray-900 text-white text-sm" data-id="${q.id}">Save text</button>
          <button class="btn-toggle px-3 py-2 rounded-xl bg-gray-100 text-gray-900 text-sm" data-id="${q.id}">
            ${q.active ? 'Deactivate' : 'Activate'}
          </button>
          <button class="btn-delete px-3 py-2 rounded-xl bg-white text-red-700 text-sm ring-1 ring-red-300" data-id="${q.id}" title="Prefer deactivating">Delete</button>
        </div>
      `

      // Save text
      wrap.querySelector('.btn-save').onclick = async (e) => {
        const id = e.currentTarget.dataset.id
        const ta = wrap.querySelector(`textarea[data-id="${id}"]`)
        const text = ta.value.trim()
        const { error } = await supabase.from('questions').update({ text }).eq('id', id)
        if (error) alert('Update failed: ' + error.message); else alert('Saved')
      }

      // Toggle active (button)
      wrap.querySelector('.btn-toggle').onclick = async (e) => {
        const id = e.currentTarget.dataset.id
        const isActive = wrap.querySelector('span').textContent.trim() === 'active'
        const { error } = await supabase.from('questions').update({ active: !isActive }).eq('id', id)
        if (error) alert('Toggle failed: ' + error.message); else loadQuestions()
      }

      // NEW: Active checkbox (instant)
      wrap.querySelector('.activeChk').onchange = async (e) => {
        const id = e.currentTarget.dataset.id
        const { error } = await supabase.from('questions').update({ active: e.currentTarget.checked }).eq('id', id)
        if (error) alert('Update failed: ' + error.message)
      }

      // NEW: Level select (instant)
      wrap.querySelector('.levelSel').onchange = async (e) => {
        const id = e.currentTarget.dataset.id
        const level = parseInt(e.currentTarget.value, 10)
        const { error } = await supabase.from('questions').update({ level }).eq('id', id)
        if (error) alert('Update failed: ' + error.message)
      }

      // NEW: Copy to form
      wrap.querySelector('.btn-copy').onclick = () => {
        const id = q.id
        qtext.value = wrap.querySelector(`textarea[data-id="${id}"]`).value
        qlevel.value = String(q.level ?? 1)
        qcat.value   = q.category || 'shimedaiko'
        qactive.value= 'true'
        copyIdSpan.textContent = id
        copyHint.classList.remove('hidden')
        // focus
        qtext.focus()
        qtext.scrollIntoView({ behavior: 'smooth', block: 'center' })
      }

      // Delete
      wrap.querySelector('.btn-delete').onclick = async (e) => {
        const id = e.currentTarget.dataset.id
        if (!confirm('Delete this question? Prefer deactivating instead.')) return
        const { error } = await supabase.from('questions').delete().eq('id', id)
        if (error) alert('Delete failed: ' + error.message); else loadQuestions()
      }

      return wrap
    }

    boot()
  </script>
</body>
</html>