<script type="module">
  import { renderHeader, initHeader } from './js/header.js'
  import {
    supaFromConfig, requireApprovedOrRedirect, ensureProfile,
    getOrCreateBoard, getBoardItems, generateNormalsForTrack,
    drawBonusMission, uploadProof, signOut
  } from './js/user-common.js'

  // Header
  document.getElementById('siteHeader').outerHTML = renderHeader({
    nav: [['Home','./index.html'], ['Tracks','./tracks.html']],
    withAuth:true
  })
  initHeader()

  const supabase = supaFromConfig()
  document.getElementById('signout')?.addEventListener('click', () => signOut(supabase))

  // Elements
  const whoami     = document.getElementById('whoami')
  const grid       = document.getElementById('grid')
  const progressEl = document.getElementById('progress')
  const verifiedEl = document.getElementById('verified')
  const exportBtn  = document.getElementById('exportBtn')
  const shareBtn   = document.getElementById('shareBtn')

  // New: pass & bonus UI
  const statusBar  = document.createElement('section')
  statusBar.className = 'mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3'
  statusBar.innerHTML = `
    <div class="flex items-center gap-2">
      <span id="passBadge" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 ring-1 ring-gray-200">Pass requires 3 verified</span>
      <span id="bonusBadge" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 ring-1 ring-gray-200">Bonus locked</span>
    </div>
    <div id="bonusCard" class="hidden">
      <button id="bonusBtn" class="px-3 py-2 rounded-lg bg-amber-500 text-white text-sm disabled:opacity-50">Draw Bonus Mission</button>
      <span id="bonusMsg" class="ml-2 text-sm text-gray-600"></span>
    </div>`
  document.querySelector('main').insertBefore(statusBar, document.getElementById('boardWrap'))

  const passBadge  = statusBar.querySelector('#passBadge')
  const bonusBadge = statusBar.querySelector('#bonusBadge')
  const bonusCard  = statusBar.querySelector('#bonusCard')
  const bonusBtn   = statusBar.querySelector('#bonusBtn')
  const bonusMsg   = statusBar.querySelector('#bonusMsg')

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
  const levelBadge = (n)=>`<span class="ml-2 text-[10px] px-1.5 py-0.5 rounded ring-1 ring-gray-200 bg-gray-50 text-gray-700">Lv ${n}</span>`

  async function boot(){
    const params = new URLSearchParams(location.search)
    const track  = (params.get('track') || '').toLowerCase()
    const dayNo  = params.get('day') ? Number(params.get('day')) : 1
    if (!track) { window.location.replace('./tracks.html'); return }

    const guard = await requireApprovedOrRedirect(supabase, { redirectTo:'./access.html' })
    if (guard.redirected) return

    const { user } = await ensureProfile(supabase)
    whoami?.classList.remove('hidden')
    if (whoami) whoami.textContent = `Signed in as ${user.email}`

    const board = await getOrCreateBoard(supabase, dayNo)
    // Generate ONLY normals (4). Bonus will be drawn later.
    await generateNormalsForTrack(supabase, board.id, track, 4)

    document.querySelector('h1').textContent = `My Quest Board · ${track} · Day ${dayNo}`
    await renderBoard(board.id, track)

    // Wire bonus button
    bonusBtn.onclick = async () => {
      bonusBtn.disabled = true
      bonusMsg.textContent = 'Drawing…'
      try {
        const res = await drawBonusMission(supabase, board.id, track, 4)
        bonusMsg.textContent = res?.created ? 'Bonus added!' : 'Bonus already present.'
        await renderBoard(board.id, track)
      } catch (e) {
        bonusMsg.textContent = e.message || 'Not eligible yet.'
      } finally {
        setTimeout(()=>{ bonusMsg.textContent='' }, 2500)
        bonusBtn.disabled = false
      }
    }
  }

  async function renderBoard(boardId, track) {
    const all = await getBoardItems(supabase, boardId)

    const normals = all.filter(it => (it.track||'').toLowerCase() === track && !it.is_bonus)
    const bonus   = all.filter(it => (it.track||'').toLowerCase() === track && it.is_bonus)

    // Progress & verification counts
    const totalNormals = normals.length
    const submittedNormals = normals.filter(it => !!it.proof_url).length
    const verifiedNormals  = normals.filter(it => !!it.verified).length

    const bonusSubmitted = bonus.some(it => !!it.proof_url)
    const bonusVerified  = bonus.some(it => !!it.verified)

    progressEl.textContent = `${submittedNormals}/${totalNormals} submitted`
    verifiedEl.textContent = `${verifiedNormals} verified`

    // Pass / bonus badges
    if (verifiedNormals >= 3) {
      passBadge.textContent = 'Pass ✓ (3 verified)'
      passBadge.className = 'text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200'
    } else {
      passBadge.textContent = `Pass requires 3 verified · ${verifiedNormals}/3`
      passBadge.className = 'text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 ring-1 ring-gray-200'
    }

    const allFourVerified = (totalNormals >= 4) && (verifiedNormals === 4)
    const hasBonus = bonus.length > 0

    if (hasBonus) {
      bonusBadge.textContent = bonusVerified ? 'Bonus ✓ Verified' : (bonusSubmitted ? 'Bonus submitted' : 'Bonus active')
      bonusBadge.className   = 'text-xs px-2 py-1 rounded-full bg-amber-50 text-amber-800 ring-1 ring-amber-200'
      bonusCard.classList.add('hidden') // already drawn → hide button
    } else {
      bonusBadge.textContent = allFourVerified ? 'Bonus unlocked' : 'Bonus locked'
      bonusBadge.className   = allFourVerified
        ? 'text-xs px-2 py-1 rounded-full bg-amber-50 text-amber-800 ring-1 ring-amber-200'
        : 'text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 ring-1 ring-gray-200'
      bonusCard.classList.toggle('hidden', !allFourVerified)
      bonusBtn.disabled = !allFourVerified
    }

    // Render cards (normals first, then bonus if any)
    grid.innerHTML = ''
    const renderCell = (it, idx, tagHtml='') => {
      const cell = document.createElement('div')
      cell.className = 'rounded-xl ring-1 ring-black/5 bg-white p-3 flex flex-col gap-2'
      cell.innerHTML = `
        <div class="text-xs text-gray-500">#${idx}${tagHtml} ${levelBadge(it.questions?.level)}</div>
        <div class="text-sm text-gray-900">${escapeHtml(it.questions?.text || '')}</div>
        <div class="flex items-center gap-2 mt-1">
          ${it.proof_url
            ? `<a href="${it.proof_url}" target="_blank" class="text-xs underline break-all">View proof</a>`
            : `<span class="text-xs text-gray-500">No proof yet</span>`}
          ${it.verified ? `<span class="ml-auto text-xs text-emerald-700">Verified ✓</span>` : ''}
        </div>
        <div class="flex items-center justify-between gap-2">
          <input type="file" accept="image/*,video/*" data-id="${it.id}" class="text-xs">
          <button class="btn-upload px-2.5 py-1.5 rounded-lg bg-gray-900 text-white text-xs" data-id="${it.id}">Upload</button>
        </div>`
      grid.appendChild(cell)
    }

    normals.forEach((it, i) => renderCell(it, i+1))
    bonus.forEach((it) => renderCell(
      it,
      normals.length + 1,
      `<span class="ml-2 text-[10px] px-1.5 py-0.5 rounded bg-amber-100 text-amber-800 ring-1 ring-amber-200">Bonus</span>`
    ))

    // Wire uploads
    grid.querySelectorAll('.btn-upload').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.dataset.id
        const inp = grid.querySelector(`input[type=file][data-id="${id}"]`)
        const file = inp?.files?.[0]
        if (!file) { alert('Choose a file first.'); return }
        try {
          await uploadProof(supabase, id, file)
          await renderBoard(boardId, track)
        } catch (err) { alert(err.message || 'Upload failed') }
      })
    })
  }

  // Export / Share (unchanged)
  exportBtn.onclick = async () => {
    exportBtn.disabled = true
    try {
      const canvas = await html2canvas(document.getElementById('grid'), { backgroundColor: '#ffffff', scale: 2 })
      const url = canvas.toDataURL('image/png')
      const a = document.createElement('a'); a.href = url; a.download = 'taiko-quest-board.png'; a.click()
    } finally { exportBtn.disabled = false }
  }
  shareBtn.onclick = async () => {
    try {
      const canvas = await html2canvas(document.getElementById('grid'), { backgroundColor: '#ffffff', scale: 2 })
      const blob = await new Promise(res => canvas.toBlob(res, 'image/png'))
      if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'taiko-quest-board.png', { type: 'image/png' })] })) {
        const file = new File([blob], 'taiko-quest-board.png', { type: 'image/png' })
        await navigator.share({ files: [file], title: 'My Taiko Quest Board' })
      } else {
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a'); a.href = url; a.download = 'taiko-quest-board.png'; a.click()
        URL.revokeObjectURL(url)
      }
    } catch { alert('Share failed.') }
  }

  boot()
</script>