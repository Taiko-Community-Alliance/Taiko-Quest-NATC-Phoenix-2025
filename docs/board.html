<!doctype html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Quest Board · Taiko Quest NATC Phoenix 2025</title>
  <meta name="color-scheme" content="light only">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'title': ['"ITC Officina Sans"', '"Fira Sans"', 'sans-serif'],
            'body': ['"Trade Gothic Condensed"', '"Helvetica Neue"', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@600&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Helvetica Neue';
      src: url('https://fonts.cdnfonts.com/css/helvetica-neue-9');
      font-weight: 300;
      font-style: normal;
    }
    @font-face {
      font-family: 'Helvetica Neue';
      src: url('https://fonts.cdnfonts.com/css/helvetica-neue-9');
      font-weight: 700;
      font-style: normal;
    }
  </style>
  <script src="./config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-wrap items-center justify-between">
      <div class="flex items-center">
        <img src="./assets/brand/TCA-Logo.png" alt="TCA Logo" class="h-8 sm:h-10 w-auto">
        <h1 class="ml-2 sm:ml-3 text-lg sm:text-xl md:text-2xl font-bold font-title">Taiko Quest</h1>
      </div>
      <p class="text-xs sm:text-sm text-gray-500 font-body mt-1 sm:mt-0">NATC Phoenix 2025</p>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 sm:p-6 mt-4">
    <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <div>
          <div class="flex items-center justify-between">
            <h2 class="text-2xl sm:text-3xl font-bold font-title text-gray-900">My Quest Board</h2>
            <!-- Hamburger menu button (visible only on mobile) -->
            <button id="menuBtn" class="sm:hidden p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>

          <!-- Mobile menu (hidden by default on mobile, always hidden on desktop) -->
          <div id="mobileMenu" class="sm:hidden hidden mt-3 p-3 bg-gray-50 rounded-lg shadow-sm">
            <div class="flex flex-col space-y-3">
              <div class="text-sm text-gray-600 break-all">
                Signed in as: <span id="whoami">Checking session…</span>
              </div>
              <div class="text-sm font-body bg-gray-100 px-3 py-1.5 rounded-lg">
                <span id="progress" class="font-bold">0/25 submitted</span>
                <span id="verified" class="ml-2 text-gray-600">0 verified</span>
              </div>
              <button id="signout" class="px-3 py-1.5 rounded-lg bg-gray-200 text-gray-900 text-sm font-body hover:bg-gray-300 transition-colors">Sign out</button>
            </div>
          </div>

          <!-- Desktop view (hidden on mobile, visible on desktop) -->
          <div class="hidden sm:flex sm:flex-wrap sm:items-center sm:mt-1 sm:w-full sm:overflow-hidden">
            <span class="text-sm text-gray-600 break-all mr-2">Signed in as: <span id="whoami-desktop">Checking session…</span></span>
            <button id="signout-desktop" class="px-3 py-1.5 rounded-lg bg-gray-200 text-gray-900 text-sm font-body hover:bg-gray-300 transition-colors">Sign out</button>
          </div>
        </div>
        <div class="hidden sm:flex sm:flex-wrap sm:items-center sm:gap-2 sm:mt-0 sm:w-auto sm:overflow-hidden">
          <div class="text-sm font-body bg-gray-100 px-3 py-1.5 rounded-lg w-full sm:w-auto overflow-hidden">
            <span id="progress-desktop" class="font-bold">0/25 submitted</span>
            <span id="verified-desktop" class="ml-2 text-gray-600">0 verified</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-wrap gap-2 mb-6 w-full overflow-hidden">
        <button id="exportBtn" class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-body font-bold hover:bg-gray-800 transition-colors">Export board as image</button>
        <button id="shareBtn" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 text-sm font-body hover:bg-gray-200 transition-colors">Share</button>
        <a href="./index.html" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 text-sm font-body hover:bg-gray-200 transition-colors md:ml-auto text-center">← Back to Home</a>
      </div>
    </div>

    <section id="boardWrap">
      <div id="grid" class="bg-white rounded-xl shadow-sm p-3 sm:p-5 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4"></div>
      <p id="note" class="text-xs text-gray-500 mt-2 font-body">
        Tip: Photos up to 2 MB, videos up to 10 MB. A coordinator will mark items as Verified ✓.
      </p>
    </section>

    <section id="gate" class="mt-6 hidden">
      <div class="bg-amber-50 text-amber-900 ring-1 ring-amber-200 rounded-xl p-5">
        <p id="gateMsg" class="text-sm font-body"></p>
        <div id="consentBtns" class="mt-4 flex flex-wrap gap-3 hidden">
          <button id="agreeBtn" class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-body font-bold hover:bg-gray-800 transition-colors">I Agree</button>
          <a href="./TERMS.html" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 text-sm font-body hover:bg-gray-200 transition-colors">Read Terms</a>
          <a href="./PRIVACY.html" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 text-sm font-body hover:bg-gray-200 transition-colors">Privacy</a>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const { SUPABASE_URL, SUPABASE_KEY } = window.__ENV || {}
    if (!SUPABASE_URL || !SUPABASE_KEY) { alert('Missing Supabase config'); throw new Error('No config') }
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    // Mobile elements
    const whoami = document.getElementById('whoami')
    const signout = document.getElementById('signout')
    const progressEl = document.getElementById('progress')
    const verifiedEl = document.getElementById('verified')

    // Desktop elements
    const whoamiDesktop = document.getElementById('whoami-desktop')
    const signoutDesktop = document.getElementById('signout-desktop')
    const progressDesktopEl = document.getElementById('progress-desktop')
    const verifiedDesktopEl = document.getElementById('verified-desktop')

    // Common elements
    const menuBtn = document.getElementById('menuBtn')
    const mobileMenu = document.getElementById('mobileMenu')
    const grid = document.getElementById('grid')
    const exportBtn = document.getElementById('exportBtn')
    const shareBtn = document.getElementById('shareBtn')
    const gate = document.getElementById('gate')
    const gateMsg = document.getElementById('gateMsg')
    const consentBtns = document.getElementById('consentBtns')
    const agreeBtn = document.getElementById('agreeBtn')

    // Toggle mobile menu
    menuBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden')
    })

    // Sign out functionality for both mobile and desktop buttons
    const handleSignOut = async () => { 
      await supabase.auth.signOut()
      location.href = './access.html' 
    }

    signout.onclick = handleSignOut
    signoutDesktop.onclick = handleSignOut

    // Boot
    supabase.auth.getUser().then(async ({ data:{ user } }) => {
      if (!user) { location.href = './access.html'; return }
      // Update both mobile and desktop elements with user email
      whoami.textContent = user.email
      whoamiDesktop.textContent = user.email

      // Gate: consent + approval
      const { data: p, error } = await supabase.from('profiles').select('consent,approved').eq('id', user.id).maybeSingle()
      if (error) { alert('Error loading profile: ' + error.message); return }
      if (!p?.consent) {
        gate.classList.remove('hidden')
        gateMsg.textContent = 'Please agree to media usage to continue.'
        consentBtns.classList.remove('hidden')
        agreeBtn.onclick = async () => {
          await supabase.from('profiles').update({ consent: true }).eq('id', user.id)
          location.reload()
        }
        return
      }
      if (!p?.approved) {
        gate.classList.remove('hidden')
        gateMsg.textContent = 'Your access is pending approval. Please check back later.'
        return
      }

      const board = await ensureBoard(user.id)
      await renderBoard(board.id)
    })

    async function ensureBoard(uid) {
      const { data: b, error: bErr } = await supabase.from('quest_boards').select('id').eq('user_id', uid).maybeSingle()
      if (bErr) throw bErr
      if (b) return b

      const LEVEL_TARGETS = { easy: 13, medium: 9, hard: 3 }
      const { data: allQs, error: qErr } = await supabase.from('questions').select('id, level, text').eq('active', true)
      if (qErr) throw qErr
      if (!allQs?.length) throw new Error('No active questions found.')

      const byLevel = { easy: [], medium: [], hard: [] }
      for (const q of allQs) (byLevel[q.level] || (byLevel[q.level] = [])).push(q)
      function pick(arr, n) { const a = arr.slice(); for (let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a.slice(0,n) }

      let selected = []
      for (const lvl of ['easy','medium','hard']) {
        const want = LEVEL_TARGETS[lvl]
        const got = Math.min(want, byLevel[lvl]?.length || 0)
        selected = selected.concat(pick(byLevel[lvl] || [], got))
      }
      if (selected.length < 25) {
        const remaining = allQs.filter(q => !selected.some(s => s.id === q.id))
        selected = selected.concat(pick(remaining, Math.max(0, 25 - selected.length)))
      }
      selected = selected.slice(0, 25)

      const { data: insertedBoards, error: iErr } = await supabase.from('quest_boards').insert({ user_id: uid }).select()
      if (iErr) throw iErr
      const board = insertedBoards[0]

      const items = selected.map(q => ({ board_id: board.id, question_id: q.id }))
      const { error: biErr } = await supabase.from('board_items').insert(items)
      if (biErr) throw biErr
      return board
    }

    async function renderBoard(boardId) {
      const { data: items, error } = await supabase
        .from('board_items')
        .select('id, proof_url, verified, questions(text)')
        .eq('board_id', boardId)
      if (error) { grid.innerHTML = errorCard(error.message); return }

      const submitted = items.filter(it => !!it.proof_url).length
      const verified  = items.filter(it => !!it.verified).length

      // Update both mobile and desktop progress elements
      progressEl.textContent = `${submitted}/25 submitted`
      verifiedEl.textContent = `${verified} verified`

      // Update desktop progress elements
      progressDesktopEl.textContent = `${submitted}/25 submitted`
      verifiedDesktopEl.textContent = `${verified} verified`

      grid.innerHTML = ''
      items.forEach((it, idx) => {
        const cell = document.createElement('div')
        cell.className = 'rounded-xl shadow-sm bg-white p-4 flex flex-col gap-2'
        cell.innerHTML = `
          <div class="text-xs text-gray-500 font-body">#${idx+1}</div>
          <div class="text-sm text-gray-900 font-body font-bold">${escapeHtml(it.questions?.text || '')}</div>
          <div class="flex items-center gap-2 mt-2">
            ${it.proof_url ? `<a href="${it.proof_url}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 font-body underline break-all">View proof</a>` : `<span class="text-xs text-gray-500 font-body">No proof yet</span>`}
            ${it.verified ? `<span class="ml-auto text-xs text-emerald-700 font-body font-bold">Verified ✓</span>` : ''}
          </div>
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mt-2 pt-2 border-t border-gray-100">
            <div class="w-full sm:w-auto overflow-hidden">
              <input type="file" accept="image/*,video/*" data-id="${it.id}" class="text-xs font-body max-w-full">
            </div>
            <button class="btn-upload px-3 py-1.5 rounded-lg bg-gray-900 text-white text-xs font-body font-bold hover:bg-gray-800 transition-colors w-full sm:w-auto mt-1 sm:mt-0" data-id="${it.id}">Upload</button>
          </div>
        `
        grid.appendChild(cell)
      })

      grid.querySelectorAll('.btn-upload').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.dataset.id
          const inp = grid.querySelector(`input[type=file][data-id="${id}"]`)
          const file = inp?.files?.[0]
          if (!file) { alert('Choose a file first.'); return }
          btn.disabled = true; btn.textContent = 'Uploading…'
          try {
            await handleUpload(id, file)
            await renderBoard(boardId)
          } finally {
            btn.disabled = false; btn.textContent = 'Upload'
          }
        })
      })
    }

    async function handleUpload(itemId, file) {
      const isVideo = file.type.startsWith('video/')
      const max = isVideo ? 10 * 1024 * 1024 : 2 * 1024 * 1024
      if (file.size > max) { alert(`File too large. Max ${isVideo ? '10MB video' : '2MB photo'}.`); return }
      const { data:{ user } } = await supabase.auth.getUser()
      const ext = (file.name.split('.').pop() || (isVideo ? 'mp4' : 'jpg')).toLowerCase().replace(/[^\w]/g,'')
      const path = `${user.id}/${itemId}/${Date.now()}.${ext}`

      const { error: upErr } = await supabase.storage.from('proofs').upload(path, file, { upsert: true })
      if (upErr) { alert('Upload failed: ' + upErr.message); return }

      const { data: pub } = supabase.storage.from('proofs').getPublicUrl(path)
      const { error: saveErr } = await supabase.from('board_items').update({ proof_url: pub.publicUrl }).eq('id', itemId)
      if (saveErr) { alert('Save failed: ' + saveErr.message) }
    }

    exportBtn.onclick = async () => {
      exportBtn.disabled = true
      try {
        const canvas = await html2canvas(document.getElementById('grid'), { backgroundColor: '#ffffff', scale: 2 })
        const url = canvas.toDataURL('image/png')
        const a = document.createElement('a'); a.href = url; a.download = 'taiko-quest-board.png'; a.click()
      } catch { alert('Export failed.') } finally { exportBtn.disabled = false }
    }

    shareBtn.onclick = async () => {
      try {
        const canvas = await html2canvas(document.getElementById('grid'), { backgroundColor: '#ffffff', scale: 2 })
        const blob = await new Promise(res => canvas.toBlob(res, 'image/png'))
        if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'taiko-quest-board.png', { type: 'image/png' })] })) {
          const file = new File([blob], 'taiko-quest-board.png', { type: 'image/png' })
          await navigator.share({ files: [file], title: 'My Taiko Quest Board' })
        } else {
          const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'taiko-quest-board.png'; a.click(); URL.revokeObjectURL(url)
        }
      } catch { alert('Share failed.') }
    }

    function errorCard(msg) {
      return `<div class="bg-white rounded-2xl ring-1 ring-red-300 p-6 text-red-700">Error: ${msg}</div>`
    }
    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))
    }
  </script>
</body>
</html>
