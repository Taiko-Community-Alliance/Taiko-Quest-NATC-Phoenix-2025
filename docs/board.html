<!-- docs/board.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Quest Board · Taiko Quest NATC Phoenix 2025</title>
  <link rel="stylesheet" href="./assets/tailwind.css">
  <script src="./config.js"></script>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div id="siteHeader"></div>
  <main class="px-4 py-6 space-y-4">
    <!-- Title & subtitle -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-3xl font-bold">My Quest Board</h1>
        <p id="subtitle" class="text-sm text-gray-600 dark:text-gray-400"></p>
      </div>
      <a href="./tracks.html" class="mt-2 sm:mt-0 inline-flex items-center px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-sm text-gray-700 dark:text-gray-200">Tracks</a>
    </div>

    <!-- Score & actions -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="flex items-center gap-2">
        <span id="progress" class="text-xl font-bold"></span>
        <!-- verified count still available, but we focus on score -->
      </div>
      <div class="flex gap-2 hidden md:block">
        <button id="exportBtn" class="px-3 py-2 rounded-lg bg-gray-900 dark:bg-gray-700 text-white text-sm">Export board</button>
        <button id="shareBtn" class="px-3 py-2 rounded-lg bg-gray-900 dark:bg-gray-700 text-white text-sm">Share</button>
      </div>
    </div>

    <p class="text-xs text-gray-500 dark:text-gray-400">
      Upload photos (max 2 MB) or videos (max 10 MB). A coordinator will mark items as verified.
    </p>

    <!-- Consent gate (unchanged) -->
    <div id="gate" class="hidden max-w-md mx-auto p-5 rounded-xl ring-1 ring-black/5 dark:ring-gray-700 bg-white dark:bg-gray-800 space-y-4">
      <p id="gateMsg" class="text-sm"></p>
      <div id="consentBtns" class="hidden flex gap-3">
        <button id="agreeBtn" class="flex-1 px-3 py-2 rounded-lg bg-gray-900 dark:bg-gray-700 text-white">I Agree</button>
        <a href="./TERMS.html" class="flex-1 px-3 py-2 rounded-lg text-center bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200">Read Terms</a>
      </div>
    </div>

    <!-- Mission grid -->
    <div id="grid" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
  </main>
  <footer class="py-4 text-center text-xs text-gray-500 dark:text-gray-400">
    © <span id="y"></span> Taiko Community Alliance
  </footer>

  <script type="module">
    import { renderHeader, initHeader, bindAuthHeader } from './js/header.js';
    import {
      supaFromConfig, requireSignedInOrRedirect, ensureProfile,
      getBoardItems, uploadProof, agreeConsent
    } from './js/user-common.js';

    // Inject header with auth buttons
    document.getElementById('siteHeader').outerHTML = renderHeader({
      admin: false,
      nav: [['Home', './index.html']],
      withAuth: true
    });
    initHeader();

    const supabase = supaFromConfig();
    bindAuthHeader(supabase, { signInHref: './access.html' })
    console.log('Supabase initialized', supabase);

    (async () => {
      const grid        = document.getElementById('grid');
      const progressEl  = document.getElementById('progress');
      const exportBtn   = document.getElementById('exportBtn');
      const shareBtn    = document.getElementById('shareBtn');
      const gate        = document.getElementById('gate');
      const gateMsg     = document.getElementById('gateMsg');
      const consentBtns = document.getElementById('consentBtns');
      const agreeBtn    = document.getElementById('agreeBtn');
      const subtitle    = document.getElementById('subtitle');

      // Require approved profile
      const guard = await requireSignedInOrRedirect(supabase, { redirectTo: './access.html' });
      if (guard.redirected) return;
      const { user, profile } = await ensureProfile(supabase);
      // Consent check
      if (!profile?.consent) {
        gate.classList.remove('hidden');
        gateMsg.textContent = 'Please agree to media usage to continue.';
        consentBtns.classList.remove('hidden');
        agreeBtn.onclick = async () => {
          await agreeConsent(supabase);
          window.location.reload();
        };
        return;
      }

      // Determine board ID
      const params = new URLSearchParams(location.search);
      let boardId = params.get('board');
      if (!boardId) {
        const { data } = await supabase
          .from('quest_boards')
          .select('id')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(1);
        boardId = data?.[0]?.id || null;
      }
      if (!boardId) { location.replace('./tracks.html'); return; }

      // Optional: set subtitle with track/day info
      const { data: meta } = await supabase.from('quest_boards')
        .select('track, day_no')
        .eq('id', boardId)
        .maybeSingle();
      if (meta?.track || meta?.day_no) {
        const trackNames = { shimedaiko:'Shimedaiko', odaiko:'Odaiko', chudaiko:'Chūdaiko', okedo:'Okedō' };
        const label      = trackNames[meta.track] || meta.track || '';
        const when       = meta.day_no || '';
        subtitle.textContent = [label, when].filter(Boolean).join(' • ');
      }

      await renderBoard(boardId);

      async function renderBoard(id) {
        const items = await getBoardItems(supabase, id);

        // Filter and sort by question level (level 1–4 plus secret mission level 5)
        const questions  = items.filter(it => it.questions && it.questions.active && !it.questions.is_bonus).sort((a,b) => (a.questions.level ?? 1) - (b.questions.level ?? 1));
        console.log('Board items', items, 'Filtered questions', questions);
        const completed  = questions.filter(t => !!t.proof_url).length;

        // Show secret mission if 4 tasks have submissions
        const showSecret = (completed >= 4) && false;
        console.log(questions)
        const missions    = questions.filter(t => (t.questions.level <= 4) || (showSecret && t.questions.level == 5)).slice(0, showSecret ? 5 : 4);

        // Score styling (3 -> green, 4 -> gold, 5 -> teal)
        let scoreColor = 'text-gray-900 dark:text-gray-100';
        if (completed >= 3 && completed < 4) scoreColor = 'text-emerald-600';
        if (completed >= 4 && completed < 5) scoreColor = 'text-yellow-600';
        if (completed >= 5) scoreColor = 'text-teal-600';
        const total = showSecret ? 5 : 4;
        progressEl.textContent = `${completed}/${total}`;
        progressEl.className   = `text-xl font-bold ${scoreColor}`;
        if (completed === total) {
          progressEl.textContent += ' 🎉 All done!';
        }
        // Render each mission cell
        grid.innerHTML = '';
        console.log('Missions to render', missions);
        missions.forEach((it, idx) => {
          console.log('Rendering item', it);
          const cell = document.createElement('div');
          // make cards variable height on mobile, square from sm: up
          cell.className = 'relative rounded-xl ring-1 ring-black/5 dark:ring-gray-700 overflow-hidden bg-white dark:bg-gray-800 flex flex-col justify-between h-auto sm:aspect-square min-w-0';

          // ...
          if (it.proof_url) {
            const ext = it.proof_url.split('.').pop().toLowerCase();
            const isVideo = ['mp4','mov','webm','ogg'].includes(ext);
            cell.innerHTML = `
              ${isVideo
                ? `<video src="${it.proof_url}" class="w-full h-56 sm:h-full object-cover" preload="metadata" controls muted></video>`
                : `<img src="${it.proof_url}" class="w-full h-56 sm:h-full object-cover" alt="submission">`
              }
              <div class="absolute top-1 right-1 px-2 py-0.5 rounded-full text-xs font-semibold ${it.verified ? 'bg-emerald-100 text-emerald-700' : 'bg-yellow-100 text-yellow-700'}">
                ${it.verified ? 'Verified ✓' : 'Pending Verification'}
              </div>
            `;
          } else {
            cell.innerHTML = `
              <div class="p-3 flex-1 flex flex-col items-center text-center min-w-0">
                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Mission ${idx+1}</div>
                <div class="text-sm text-gray-900 dark:text-gray-100 break-words whitespace-pre-line line-clamp-6 sm:line-clamp-none overflow-hidden min-w-0">
                  ${escapeHtml(it.questions.text)}
                </div>
              </div>
              <div class="p-3 flex items-center gap-2">
                <input type="file" accept="image/*,video/*" data-id="${it.id}" class="text-xs flex-1 min-w-0">
                <button class="btn-upload px-3 py-2 rounded-lg bg-gray-900 dark:bg-gray-700 text-white text-xs font-medium" data-id="${it.id}">Upload</button>
              </div>
            `;
          }
          grid.appendChild(cell);
        });

        // Attach upload handlers
        grid.querySelectorAll('.btn-upload').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id  = e.currentTarget.dataset.id;
            const inp = grid.querySelector(`input[type=file][data-id="${id}"]`);
            const file = inp?.files?.[0];
            if (!file) {
              alert('Choose a file first.');
              return;
            }
            try {
              await uploadProof(supabase, id, file);
              await renderBoard(boardId);
            } catch (err) {
              alert(err.message || 'Upload failed');
            }
          });
        });
      }

      // Export/Share (unchanged)
      exportBtn.onclick = async () => {
        exportBtn.disabled = true;
        try {
          const canvas = await html2canvas(document.getElementById('grid'), { backgroundColor: '#ffffff', scale: 2 });
          const url    = canvas.toDataURL('image/png');
          const a      = document.createElement('a');
          a.href       = url;
          a.download   = 'taiko-quest-board.png';
          a.click();
        } finally {
          exportBtn.disabled = false;
        }
      };
      shareBtn.onclick = async () => {
        try {
          const canvas = await html2canvas(document.getElementById('grid'), { backgroundColor: '#ffffff', scale: 2 });
          const blob   = await new Promise(res => canvas.toBlob(res, 'image/png'));
          if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'taiko-quest-board.png', { type: 'image/png' })] })) {
            const file = new File([blob], 'taiko-quest-board.png', { type: 'image/png' });
            await navigator.share({ files: [file], title: 'Taiko Quest Board', text: 'Check out my Taiko Quest board!' });
          } else {
            alert('Sharing is not supported in this browser.');
          }
        } catch (err) {
          alert(err.message || 'Share failed');
        }
      };

    })();
    document.getElementById('y').textContent = new Date().getFullYear();

    function escapeHtml(s='') {
      return s.replace(/[&<>"']/g, c => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]));
    }
  </script>
</body>
</html>
