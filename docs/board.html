<!doctype html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Quest Board · Taiko Quest NATC Phoenix 2025</title>
  <link rel="stylesheet" href="./assets/tailwind.css">
  <script src="./config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body class="h-full">
  <!-- Header (injected) -->
  <div id="siteHeader"></div>

  <main class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <h1 class="text-2xl sm:text-3xl font-semibold">My Quest Board</h1>
        <p id="subtitle" class="text-sm text-gray-600">Taiko Quest NATC Phoenix 2025</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <a href="./tracks.html" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Tracks</a>
      </div>
    </header>

    <section class="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="text-sm">
        <span id="progress" class="font-medium">0/0 submitted</span>
        <span id="verified" class="ml-2 text-gray-600">0 verified</span>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="exportBtn" class="px-3 py-2 rounded-lg bg-gray-900 text-white text-sm">Export board as image</button>
        <button id="shareBtn" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Share</button>
      </div>
    </section>

    <section id="boardWrap" class="mt-4">
      <div id="grid" class="bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-3 sm:p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3"></div>
      <p id="note" class="text-xs text-gray-500 mt-2">Tip: Photos up to 2 MB, videos up to 10 MB. A coordinator will mark items as Verified ✓.</p>
    </section>

    <section id="gate" class="mt-6 hidden">
      <div class="bg-amber-50 text-amber-900 ring-1 ring-amber-200 rounded-2xl p-4">
        <p id="gateMsg" class="text-sm"></p>
        <div id="consentBtns" class="mt-3 hidden">
          <button id="agreeBtn" class="px-3 py-2 rounded-lg bg-gray-900 text-white text-sm">I Agree</button>
          <a href="./TERMS.html" class="px-3 py-2 rounded-lg bg-gray-100 text-sm">Read Terms</a>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { renderHeader, initHeader } from './js/header.js'
    import {
      supaFromConfig, requireApprovedOrRedirect, ensureProfile,
      ensureBoard, getBoardItems, uploadProof, agreeConsent, signOut
    } from './js/user-common.js'

    // Inject header (with auth controls)
    document.getElementById('siteHeader').outerHTML = renderHeader({
      admin: false,
      nav: [['Home','./index.html']],
      withAuth: true
    })
    initHeader()

    const supabase = supaFromConfig()
    document.getElementById('signout')?.addEventListener('click', async () => {
      await signOut(supabase); location.href = './access.html'
    })

    ;(async () => {
      const grid = document.getElementById('grid')
      const progressEl = document.getElementById('progress')
      const verifiedEl = document.getElementById('verified')
      const exportBtn = document.getElementById('exportBtn')
      const shareBtn = document.getElementById('shareBtn')
      const gate = document.getElementById('gate')
      const gateMsg = document.getElementById('gateMsg')
      const consentBtns = document.getElementById('consentBtns')
      const agreeBtn = document.getElementById('agreeBtn')
      const subtitle = document.getElementById('subtitle')

      const guard = await requireApprovedOrRedirect(supabase, { redirectTo: './access.html' })
      if (guard.redirected) return

      const { user, profile } = await ensureProfile(supabase)

      if (!profile?.consent) {
        gate.classList.remove('hidden'); gateMsg.textContent = 'Please agree to media usage to continue.'
        consentBtns.classList.remove('hidden')
        agreeBtn.onclick = async () => { await agreeConsent(supabase); window.location.reload() }
        return
      }

      // Choose board: ?board=<id> or most recent; else send to tracks
      const params = new URLSearchParams(location.search)
      let boardId = params.get('board')

      if (!boardId) {
        const { data } = await supabase
          .from('quest_boards')
          .select('id')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(1)
        boardId = data?.[0]?.id || null
      }
      if (!boardId) { location.replace('./tracks.html'); return }

      // Load board meta (track + day if present)
      const { data: meta } = await supabase
        .from('quest_boards')
        .select('track, day_date')
        .eq('id', boardId)
        .maybeSingle()
      if (meta?.track || meta?.day_date) {
        const label = trackLabel(meta?.track)
        const when  = meta?.day_date || ''
        subtitle.textContent = [label, when].filter(Boolean).join(' • ')
      }

      await renderBoard(boardId)

      async function renderBoard(id) {
        const items = await getBoardItems(supabase, id)
        const submitted = items.filter(it => !!it.proof_url).length
        const verified = items.filter(it => !!it.verified).length
        progressEl.textContent = `${submitted}/${items.length} submitted`
        verifiedEl.textContent = `${verified} verified`

        grid.innerHTML = ''
        items.forEach((it, idx) => {
          const cell = document.createElement('div')
          cell.className = 'rounded-xl ring-1 ring-black/5 bg-white p-3 flex flex-col gap-2'
          cell.innerHTML = `
            <div class="text-xs text-gray-500">#${idx+1}</div>
            <div class="text-sm text-gray-900">${escapeHtml(it.questions?.text || '')}</div>
            <div class="flex items-center gap-2 mt-1">
              ${it.proof_url
                ? `<a href="${it.proof_url}" target="_blank" class="text-xs underline break-all">View proof</a>`
                : `<span class="text-xs text-gray-500">No proof yet</span>`
              }
              ${it.verified ? `<span class="ml-auto text-xs text-emerald-700">Verified ✓</span>` : ''}
            </div>
            <div class="flex items-center justify-between gap-2">
              <input type="file" accept="image/*,video/*" data-id="${it.id}" class="text-xs">
              <button class="btn-upload px-2.5 py-1.5 rounded-lg bg-gray-900 text-white text-xs" data-id="${it.id}">Upload</button>
            </div>
          `
          grid.appendChild(cell)
        })
        grid.querySelectorAll('.btn-upload').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id
            const inp = grid.querySelector(`input[type=file][data-id="${id}"]`)
            const file = inp?.files?.[0]
            if (!file) { alert('Choose a file first.'); return }
            try { await uploadProof(supabase, id, file); await renderBoard(boardId) }
            catch (err) { alert(err.message || 'Upload failed') }
          })
        })
      }

      // Export / Share
      exportBtn.onclick = async () => {
        exportBtn.disabled = true
        try {
          const canvas = await html2canvas(document.getElementById('grid'), { backgroundColor: '#ffffff', scale: 2 })
          const url = canvas.toDataURL('image/png')
          const a = document.createElement('a'); a.href = url; a.download = 'taiko-quest-board.png'; a.click()
        } finally { exportBtn.disabled = false }
      }
      shareBtn.onclick = async () => {
        try {
          const canvas = await html2canvas(document.getElementById('grid'), { backgroundColor: '#ffffff', scale: 2 })
          const blob = await new Promise(res => canvas.toBlob(res, 'image/png'))
          if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'taiko-quest-board.png', { type: 'image/png' })] })) {
            const file = new File([blob], 'taiko-quest-board.png', { type: 'image/png' })
            await navigator.share({ files: [file], title: 'My Taiko Quest Board' })
          } else {
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'taiko-quest-board.png'; a.click(); URL.revokeObjectURL(url)
          }
        } catch { alert('Share failed.') }
      }

      function trackLabel(k){
        const map = { shimedaiko:'Shimedaiko', odaiko:'Odaiko', chudaiko:'Chūdaiko', okedo:'Okedō' }
        return map[k] || 'Taiko Quest'
      }
      function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
    })()
  </script>
</body>
</html>
