<!doctype html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Request Access · Taiko Quest NATC Phoenix 2025</title>
  <link rel="stylesheet" href="./assets/tailwind.css">
  <script src="./config.js"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <!-- Header -->
  <div id="siteHeader"></div>

  <main class="max-w-md mx-auto p-4 sm:p-6 mt-4">
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Request Access</h2>
      <p class="text-gray-600 text-sm mb-6">Fill out the form below to request access to Taiko Quest.</p>
      <form id="req" class="space-y-4">
        <div>
          <label class="block text-sm font-bold mb-1">First name</label>
          <input name="first" class="w-full rounded-xl border border-gray-300 p-3" required />
        </div>
        <div>
          <label class="block text-sm font-bold mb-1">Last name</label>
          <input name="last" class="w-full rounded-xl border border-gray-300 p-3" required />
        </div>
        <div>
          <label class="block text-sm font-bold mb-1">Email</label>
          <input name="email" type="email" class="w-full rounded-xl border border-gray-300 p-3" required />
        </div>
        <button class="w-full rounded-xl bg-gray-900 text-white py-3 font-bold">Submit Request</button>
      </form>
      <p id="msg" class="text-sm text-gray-600 mt-4"></p>
      <p class="text-xs text-gray-500 mt-2">Already approved? <a href="./access.html" class="text-gray-900 underline">Access my board</a></p>
    </div>
  </main>

  <script type="module">
    import { renderHeader, initHeader } from './js/header.js'
    import { supaFromConfig } from './js/user-common.js'

    document.getElementById('siteHeader').outerHTML = renderHeader({
      admin: false,
      nav: [['Request Access','./request.html'], ['Access My Board','./access.html']],
      withAuth: false
    })
    initHeader()

    const supabase = supaFromConfig()
    const form = document.getElementById('req')
    const msg  = document.getElementById('msg')

    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      const email = e.target.email.value.trim()
      const first = e.target.first.value.trim()
      const last  = e.target.last.value.trim()
      if (!email || !first || !last) { msg.textContent = 'All fields required.'; return }

      const { error } = await supabase.from('registrations')
        .insert({ email, first_name:first, last_name:last })
      if (error) {
        if (String(error.message).includes('duplicate') || error.code === '23505') {
          msg.textContent = 'You have already requested access. We’ll email you when approved.'
        } else {
          msg.textContent = 'Error: ' + error.message
        }
        return
      }
      form.reset()
      msg.textContent = 'Thanks! We’ll email you after approval.'
    })
  </script>
</body>
</html>