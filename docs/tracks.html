<!-- docs/tracks.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Choose Today’s Track · Taiko Quest NATC Phoenix 2025</title>
  <link rel="stylesheet" href="./assets/tailwind.css">
  <script src="./config.js"></script>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div id="siteHeader"></div>
  <main class="px-4 py-8 space-y-4">

    <!-- Day header (shows Day 1, D-1, etc.) -->
    <div class="text-center mb-4">
      <div id="dayLabel" class="text-2xl font-bold"></div>
      <div id="dayDate" class="text-xs text-gray-500 dark:text-gray-400"></div>
    </div>

    <h1 class="text-3xl font-bold text-center">Choose Today’s Track</h1>
    <p class="text-center text-sm text-gray-600 dark:text-gray-400">
      You can unlock one track per day. Each board has 4 missions + 1 secret bonus.
    </p>

    <!-- Tracks grid (responsive squares) -->
    <div id="tracksGrid" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>

    <section class="space-y-6 hidden md:block">
      <div>
        <h2 class="text-xl font-semibold">Your Track Progress</h2>
        <button id="refreshProgress" class="ml-2 px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 text-sm text-gray-700 dark:text-gray-200">Refresh</button>
        <div id="progressList" class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
      </div>
      <div>
        <h2 class="text-xl font-semibold">Recent Boards</h2>
        <button id="refreshHistory" class="ml-2 px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 text-sm text-gray-700 dark:text-gray-200">Refresh</button>
        <div id="history" class="mt-3 space-y-2"></div>
      </div>
    </section>
  </main>
  <footer class="py-4 text-center text-xs text-gray-500 dark:text-gray-400">
    © <span id="y"></span> Taiko Community Alliance
  </footer>

  <script type="module">
    import { renderHeader, initHeader, bindAuthHeader } from './js/header.js';
    import {
      supaFromConfig, requireApprovedOrRedirect, ensureProfile,
      todayStrAZ, getUserBoards, listRecentBoards,
      ensureTrackBoardForToday, trackStatsForUser, CONF_START, MAX_DAYS
    } from './js/user-common.js';

    // Insert header
    document.getElementById('siteHeader').outerHTML = renderHeader({
      admin: false,
      nav: [['Home', './index.html']],
      withAuth: true
    });
    initHeader();

    const supabase = supaFromConfig();
    bindAuthHeader(supabase, { signInHref: './access.html' })

    // Elements
    const dayLabel     = document.getElementById('dayLabel');
    const dayDate      = document.getElementById('dayDate');
    const tracksGrid   = document.getElementById('tracksGrid');
    const progressList = document.getElementById('progressList');
    const historyBox   = document.getElementById('history');
    const refreshProgress = document.getElementById('refreshProgress');
    const refreshHistory  = document.getElementById('refreshHistory');

    const TRACKS = [
      { key: 'shimedaiko', label: 'Shimedaiko' },
      { key: 'odaiko',     label: 'Odaiko' },
      { key: 'chudaiko',   label: 'Chudaiko' },
      // { key: 'okedo',      label: 'Okedo' },
    ];
    const DAILY_LIMIT = 1;

    (async () => {
      const guard = await requireApprovedOrRedirect(supabase, { redirectTo: './access.html' });
      if (guard.redirected) return;
      const { user } = await ensureProfile(supabase);

      // Determine Phoenix date
      const nowPhoenix = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Phoenix' }));
      const midnight   = new Date(nowPhoenix.getFullYear(), nowPhoenix.getMonth(), nowPhoenix.getDate());
      const dayOffset  = Math.floor((midnight - CONF_START) / (24 * 60 * 60 * 1000)) + 1;
      // Set day label
      if (dayOffset >= 0) {
        dayLabel.textContent = `Day ${dayOffset+1}`;
      } else {
        dayLabel.textContent = `D-${Math.abs(dayOffset)}`;
      }
      dayDate.textContent = `${midnight.getMonth()+1}/${midnight.getDate()}`;

      // Check if conference over (after day 4)
      const conferenceEnded = (dayOffset > MAX_DAYS);

      // Boards opened today
      const todayStr = todayStrAZ();
      const userBoards = await getUserBoards(supabase, user.id)
      const canOpenMore = userBoards.filter(b => b.status === 'open').length == 0;

      // Map by track
      const mapToday = Object.fromEntries((userBoards || []).map(b => [b.track, b]));

      // Render track cards (square)
      tracksGrid.innerHTML = '';
      TRACKS.forEach(tr => {
        const existing = mapToday[tr.key] || null;
        const card = document.createElement('div');
        card.className = 'flex flex-col items-center justify-between aspect-square rounded-xl ring-1 ring-black/5 dark:ring-gray-700 p-4 bg-white dark:bg-gray-800';
        card.innerHTML = `
          <div class="text-lg font-semibold">${tr.label}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${existing ? `Check Later for Score` : (conferenceEnded ? 'Conference ended' : canOpenMore? 'Unlock New Track': 'Finish Open Board First')}</div>
          <div class="w-full mt-auto">
            ${
              existing
                ? `<a href="./board.html?board=${existing.id}" class="block w-full px-3 py-2 rounded-lg bg-gray-900 dark:bg-gray-700 text-white text-center text-sm">Continue</a>`
                : (
                    (!conferenceEnded && canOpenMore)
                      ? `<button class="btn-start block w-full px-3 py-2 rounded-lg bg-gray-900 dark:bg-gray-700 text-white text-sm" data-track="${tr.key}">Start</button>`
                      : `<span class="block w-full text-sm text-gray-500 dark:text-gray-400 text-center">${conferenceEnded ? 'Check back next year' : 'Check back tomorrow'}</span>`
                  )
            }
          </div>
        `;
        tracksGrid.appendChild(card);
      });

      // Start track logic
      tracksGrid.querySelectorAll('.btn-start').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          // Pre-conference
          if (dayOffset < 0) {
            alert('The conference hasn’t started yet.');
            return;
          }
          // Post-conference
          if (dayOffset > MAX_DAYS) {
            alert('The conference has ended.');
            return;
          }
          const track = e.currentTarget.dataset.track;
          try {
            const board = await ensureTrackBoardForToday(supabase, user.id, track);
            location.href = `./board.html?board=${board.id}`;
          } catch (err) {
            alert(err.message || 'Could not start track.');
          }
        });
      });

      // Progress and history
      async function loadProgress() {
        progressList.innerHTML = '';
        const stats = await trackStatsForUser(supabase, user.id);
        TRACKS.forEach(tr => {
          const count = stats[tr.key] ?? 0;
          const tile = document.createElement('div');
          tile.className = 'rounded-xl ring-1 ring-black/5 dark:ring-gray-700 p-4 bg-white dark:bg-gray-800';
          tile.innerHTML = `
            <div class="text-sm text-gray-600 dark:text-gray-400">${tr.label}</div>
            <div class="mt-1 text-2xl font-semibold">${count}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">boards completed</div>
          `;
          progressList.appendChild(tile);
        });
      }
      async function loadHistory() {
        historyBox.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Loading…</div>';
        const boards = await listRecentBoards(supabase, user.id, 12);
        if (!boards.length) {
          historyBox.innerHTML = '<div class="text-gray-600 dark:text-gray-400">No past boards yet.</div>';
          return;
        }
        historyBox.innerHTML = '';
        boards.forEach(b => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between p-2 rounded-lg ring-1 ring-gray-200 dark:ring-gray-700 bg-white dark:bg-gray-800';
          row.innerHTML = `
            <div>
              <div class="font-medium">${TRACKS.find(t => t.key===b.track)?.label || b.track}</div>
            </div>
            <a href="./board.html?board=${b.id}" class="px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-700 text-sm text-gray-900 dark:text-gray-100">View</a>
          `;
          historyBox.appendChild(row);
        });
      }
      refreshProgress.addEventListener('click', loadProgress);
      refreshHistory.addEventListener('click', loadHistory);
      await Promise.all([loadProgress(), loadHistory()]);
    })();
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>
</body>
</html>
