<!doctype html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Choose Today’s Track · Taiko Quest NATC Phoenix 2025</title>
  <link rel="stylesheet" href="./assets/tailwind.css" />
  <script src="./config.js"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <!-- Header -->
  <div id="siteHeader"></div>

  <main class="max-w-5xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
      <div>
        <h1 class="text-2xl sm:text-3xl font-semibold">Pick Your Track</h1>
        <p class="text-sm text-gray-600">4 missions per day; Pass at 3 verified. Finish 4 to unlock a Bonus.</p>
      </div>
      <div class="flex items-center gap-2">
        <label for="daySelect" class="text-sm text-gray-600">Day</label>
        <select id="daySelect" class="rounded-lg border p-2 text-sm">
          <option value="1">Day 1</option>
          <option value="2">Day 2</option>
          <option value="3">Day 3</option>
          <option value="4">Day 4</option>
        </select>
      </div>
    </header>

    <section class="mt-4">
      <p id="limitNote" class="text-xs text-gray-500">You can start 1 track per day.</p>
      <div id="grid" class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
    </section>
  </main>

  <script type="module">
    import { renderHeader, initHeader } from './js/header.js'
    import {
      supaFromConfig, requireApprovedOrRedirect, getOrCreateBoard,
      generateNormalsForTrack, getBoardItems
    } from './js/user-common.js'

    // Header with auth controls
    document.getElementById('siteHeader').outerHTML = renderHeader({
      nav: [['Home','./index.html'], ['My Board','./board.html']],
      withAuth: true
    })
    initHeader()

    const supabase = supaFromConfig()
    const grid = document.getElementById('grid')
    const daySelect = document.getElementById('daySelect')
    const DAILY_LIMIT = 1
    const TRACKS = [
      { key: 'shimedaiko', label: 'Shimedaiko' },
      { key: 'odaiko',     label: 'Odaiko' },
      { key: 'chudaiko',   label: 'Chūdaiko' },
      { key: 'okedo',      label: 'Okedō' }
    ]

    // Resolve day from query; default Day 1
    const params = new URLSearchParams(location.search)
    const initialDay = Number(params.get('day') || '1')
    daySelect.value = String(Math.min(Math.max(initialDay,1),4))

    daySelect.addEventListener('change', () => {
      const url = new URL(location.href)
      url.searchParams.set('day', daySelect.value)
      location.href = url.toString()
    })

    const chip = (text, cls) => `<span class="text-[11px] px-2 py-1 rounded-full ring-1 ${cls}">${text}</span>`

    async function boot(){
      const guard = await requireApprovedOrRedirect(supabase, { redirectTo:'./access.html' })
      if (guard.redirected) return
      await renderTracks()
    }

    async function renderTracks(){
      grid.innerHTML = ''
      const dayNo = Number(daySelect.value)

      // Find or create today's board
      const board = await getOrCreateBoard(supabase, dayNo)

      // Pull all items for this board to compute per-track status
      const all = await getBoardItems(supabase, board.id)

      // Distinct tracks started today (normals only)
      const startedTracks = new Set(
        (all || []).filter(it => !it.is_bonus).map(it => (it.track || '').toLowerCase())
      )
      const usedSlots = startedTracks.size
      const canStartAnother = usedSlots < DAILY_LIMIT

      TRACKS.forEach(t => {
        const items = (all || []).filter(it => (it.track || '').toLowerCase() === t.key)
        const normals = items.filter(it => !it.is_bonus)
        const bonus   = items.filter(it => it.is_bonus)

        const verifiedNormals = normals.filter(it => it.verified).length
        const pass = verifiedNormals >= 3
        const allFourVerified = normals.length >= 4 && verifiedNormals === 4

        const bonusSubmitted = bonus.some(it => !!it.proof_url)
        const bonusVerified  = bonus.some(it => it.verified)
        const hasBonus       = bonus.length > 0

        // Status chips
        const verifiedChip = chip(`Verified ${verifiedNormals}/4`,
          verifiedNormals ? 'ring-emerald-200 bg-emerald-50 text-emerald-700' : 'ring-gray-200 bg-gray-100 text-gray-700')
        const passChip = pass
          ? chip('Pass ✓', 'ring-emerald-200 bg-emerald-50 text-emerald-700')
          : chip('Pass needs 3', 'ring-gray-200 bg-gray-100 text-gray-700')
        let bonusText = 'Bonus locked'
        let bonusCls  = 'ring-gray-200 bg-gray-100 text-gray-700'
        if (hasBonus) { bonusText = bonusVerified ? 'Bonus ✓ Verified' : (bonusSubmitted ? 'Bonus submitted' : 'Bonus active'); bonusCls = 'ring-amber-200 bg-amber-50 text-amber-800' }
        else if (allFourVerified) { bonusText = 'Bonus unlocked'; bonusCls = 'ring-amber-200 bg-amber-50 text-amber-800' }
        const bonusChip = chip(bonusText, bonusCls)

        // CTA button rules
        let ctaHtml = ''
        if (startedTracks.has(t.key)) {
          // Already started this track today → Go to board
          const url = new URL('./board.html', location.href)
          url.searchParams.set('day', String(dayNo))
          url.searchParams.set('track', t.key)
          ctaHtml = `<a href="${url.toString()}" class="w-full text-center rounded-lg bg-gray-900 text-white py-2 text-sm">Go to board</a>`
        } else if (canStartAnother) {
          // Can start a new track today
          ctaHtml = `<button data-track="${t.key}" class="btn-start w-full rounded-lg bg-gray-900 text-white py-2 text-sm">Start this track</button>`
        } else {
          // Daily limit reached
          ctaHtml = `<div class="w-full text-center rounded-lg bg-gray-100 text-gray-600 py-2 text-sm">Please check back tomorrow</div>`
        }

        const card = document.createElement('div')
        card.className = 'bg-white rounded-2xl shadow-sm ring-1 ring-black/5 p-5 flex flex-col gap-3'
        card.innerHTML = `
          <div>
            <div class="text-lg font-medium">${t.label}</div>
            <div class="mt-1 flex flex-wrap gap-2">${verifiedChip}${passChip}${bonusChip}</div>
          </div>
          <div class="mt-2">${ctaHtml}</div>
        `
        grid.appendChild(card)
      })

      // Wire "Start this track"
      grid.querySelectorAll('.btn-start').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const track = e.currentTarget.dataset.track
          e.currentTarget.disabled = true
          e.currentTarget.textContent = 'Starting…'
          try {
            await generateNormalsForTrack(supabase, board.id, track, 4)
            const url = new URL('./board.html', location.href)
            url.searchParams.set('day', String(dayNo))
            url.searchParams.set('track', track)
            location.href = url.toString()
          } catch (err) {
            alert(err.message || 'Failed to start track')
            e.currentTarget.disabled = false
            e.currentTarget.textContent = 'Start this track'
          }
        })
      })
    }

    boot()
  </script>
</body>
</html>